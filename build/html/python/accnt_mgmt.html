

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>3. Account Management &mdash; Stormpath Python Documentation  documentation</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  

  
    <link rel="stylesheet" href="_static/theme_overrides.css" type="text/css" />
  

  
        <link rel="author" title="About these documents"
              href="about.html"/>
        <link rel="index" title="Index"
              href="genindex.html"/>
        <link rel="search" title="Search" href="search.html"/>
    <link rel="top" title="Stormpath Python Documentation  documentation" href="index.html"/>
        <link rel="next" title="4. Authenticating Accounts with Stormpath" href="auth_n.html"/>
        <link rel="prev" title="2. Quickstart" href="quickstart.html"/> 

  
  <script src="_static/js/modernizr.min.js"></script>

  
  <script src="https://cdn.optimizely.com/js/225847041.js"></script>

  
  <script>
  !function(f,b,e,v,n,t,s){if(f.fbq)return;n=f.fbq=function(){n.callMethod?
  n.callMethod.apply(n,arguments):n.queue.push(arguments)};if(!f._fbq)f._fbq=n;
  n.push=n;n.loaded=!0;n.version='2.0';n.queue=[];t=b.createElement(e);t.async=!0;
  t.src=v;s=b.getElementsByTagName(e)[0];s.parentNode.insertBefore(t,s)}(window,
  document,'script','https://connect.facebook.net/en_US/fbevents.js');
  fbq('init', '986262161469311');
  fbq('track', 'PageView');
  </script>
  <noscript><img height="1" width="1" style="display:none"
  src="https://www.facebook.com/tr?id=986262161469311&ev=PageView&noscript=1"
  /></noscript>
</head>

<body class="wy-body-for-nav" role="document">

  
  <noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-NQZZFW"
  height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
  <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
  new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
  j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
  '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
  })(window,document,'script','dataLayer','GTM-NQZZFW');</script>

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          
  

          
            <a href="index.html" class="icon icon-home"> Stormpath Python Documentation
          

          
          </a>

          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          

  <div class="langpicker-container">
    <a href="#langpicker" class="langpicker-link">
      <i class="fa fa-code"></i>
      Switch Language
    </a>
    <div id="langpicker" style="display:none;">
      <div class="">
        <a href="/csharp/product-guide/latest/accnt_mgmt.html">C#</a>
      </div>
      <div class="">
        <a href="/java/product-guide/latest/accnt_mgmt.html">Java</a>
      </div>
      <div class="">
        <a href="/nodejs/product-guide/latest/accnt_mgmt.html">Node.js</a>
      </div>
      <div class="">
        <a href="/php/product-guide/latest/accnt_mgmt.html">PHP</a>
      </div>
      <div class="current">
        <a href="/python/product-guide/latest/accnt_mgmt.html">Python</a>
      </div>
      <div class="">
        <a href="/rest/product-guide/latest/accnt_mgmt.html">REST</a>
      </div>
      <div class="">
        <a href="/ruby/product-guide/latest/accnt_mgmt.html">Ruby</a>
      </div>
      <div class="">
        <a href="/vbnet/product-guide/latest/accnt_mgmt.html">Visual Basic</a>
      </div>
    </div>
  </div>

        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
  
            
            
                <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="about.html">1. About Stormpath</a><ul>
<li class="toctree-l2"><a class="reference internal" href="about.html#what-is-stormpath">1.1. What is Stormpath?</a></li>
<li class="toctree-l2"><a class="reference internal" href="about.html#the-stormpath-data-model">1.2. The Stormpath Data Model</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="quickstart.html">2. Quickstart</a><ul>
<li class="toctree-l2"><a class="reference internal" href="quickstart.html#sign-up-for-stormpath">2.1 Sign-up for Stormpath</a></li>
<li class="toctree-l2"><a class="reference internal" href="quickstart.html#create-an-api-key-pair">2.2 Create an API Key Pair</a></li>
<li class="toctree-l2"><a class="reference internal" href="quickstart.html#installing-the-sdk">2.3 Installing the SDK</a></li>
<li class="toctree-l2"><a class="reference internal" href="quickstart.html#retrieve-your-application">2.4. Retrieve Your Application</a></li>
<li class="toctree-l2"><a class="reference internal" href="quickstart.html#create-a-user-account">2.5. Create a User Account</a></li>
<li class="toctree-l2"><a class="reference internal" href="quickstart.html#authenticate-a-user-account">2.6. Authenticate a User Account</a></li>
<li class="toctree-l2"><a class="reference internal" href="quickstart.html#next-steps">2.7. Next Steps</a></li>
</ul>
</li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">3. Account Management</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#modeling-your-user-base">3.1. Modeling Your User Base</a></li>
<li class="toctree-l2"><a class="reference internal" href="#how-to-store-accounts-in-stormpath">3.2. How to Store Accounts in Stormpath</a></li>
<li class="toctree-l2"><a class="reference internal" href="#how-to-search-accounts">3.3. How to Search Accounts</a></li>
<li class="toctree-l2"><a class="reference internal" href="#how-to-manage-an-account-s-password">3.4. How to Manage an Account&#8217;s Password</a></li>
<li class="toctree-l2"><a class="reference internal" href="#how-to-manage-an-account-s-required-attributes">3.5. How to Manage an Account&#8217;s Required Attributes</a></li>
<li class="toctree-l2"><a class="reference internal" href="#how-to-verify-an-account-s-email">3.6. How to Verify an Account&#8217;s Email</a></li>
<li class="toctree-l2"><a class="reference internal" href="#customizing-stormpath-emails">3.7. Customizing Stormpath Emails</a></li>
<li class="toctree-l2"><a class="reference internal" href="#account-linking">3.8. Account Linking</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="auth_n.html">4. Authenticating Accounts with Stormpath</a><ul>
<li class="toctree-l2"><a class="reference internal" href="auth_n.html#how-password-authentication-works-in-stormpath">4.1. How Password Authentication Works in Stormpath</a></li>
<li class="toctree-l2"><a class="reference internal" href="auth_n.html#how-token-based-authentication-works">4.2. How Token-Based Authentication Works</a></li>
<li class="toctree-l2"><a class="reference internal" href="auth_n.html#how-social-authentication-works">4.3. How Social Authentication Works</a></li>
<li class="toctree-l2"><a class="reference internal" href="auth_n.html#authenticating-against-an-ldap-directory">4.4. Authenticating Against an LDAP Directory</a></li>
<li class="toctree-l2"><a class="reference internal" href="auth_n.html#authenticating-against-a-saml-directory">4.5. Authenticating Against a SAML Directory</a></li>
<li class="toctree-l2"><a class="reference internal" href="auth_n.html#using-multi-factor-authentication">4.6. Using Multi-Factor Authentication</a></li>
<li class="toctree-l2"><a class="reference internal" href="auth_n.html#how-api-key-authentication-works-in-stormpath">4.7. How API Key Authentication Works in Stormpath</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="auth_z.html">5. Authorization With Stormpath</a><ul>
<li class="toctree-l2"><a class="reference internal" href="auth_z.html#what-is-authorization">5.1. What is Authorization?</a></li>
<li class="toctree-l2"><a class="reference internal" href="auth_z.html#modeling-authorization-in-stormpath">5.2. Modeling Authorization in Stormpath</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="multitenancy.html">6. Multi-Tenancy with Stormpath</a><ul>
<li class="toctree-l2"><a class="reference internal" href="multitenancy.html#what-is-a-multi-tenant-application">6.1. What Is a Multi-Tenant Application?</a></li>
<li class="toctree-l2"><a class="reference internal" href="multitenancy.html#modeling-tenants-in-stormpath">6.2. Modeling Tenants in Stormpath</a></li>
<li class="toctree-l2"><a class="reference internal" href="multitenancy.html#authenticating-an-account-against-an-organization">6.3. Authenticating an Account against an Organization</a></li>
<li class="toctree-l2"><a class="reference internal" href="multitenancy.html#routing-users-to-their-tenant">6.4 Routing Users to their Tenant</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="idsite.html">7. Using ID Site</a><ul>
<li class="toctree-l2"><a class="reference internal" href="idsite.html#what-is-an-id-site">7.1. What is an ID Site?</a></li>
<li class="toctree-l2"><a class="reference internal" href="idsite.html#how-does-id-site-work">7.2. How does ID Site Work?</a></li>
<li class="toctree-l2"><a class="reference internal" href="idsite.html#idsite-set-up">7.3. ID Site Set Up</a></li>
<li class="toctree-l2"><a class="reference internal" href="idsite.html#using-id-site-via-language">7.4. Using ID Site Via Python</a></li>
<li class="toctree-l2"><a class="reference internal" href="idsite.html#using-id-site-for-multi-tenancy">7.5. Using ID Site for Multi-tenancy</a></li>
<li class="toctree-l2"><a class="reference internal" href="idsite.html#idsite-sso">7.6. ID Site &amp; Single Sign-On</a></li>
<li class="toctree-l2"><a class="reference internal" href="idsite.html#idsite-hosting">7.7. ID Site Hosting Guide</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="configuration.html">Configuration</a><ul>
<li class="toctree-l2"><a class="reference internal" href="configuration.html#required-api-credentials">1. Required API Credentials</a></li>
<li class="toctree-l2"><a class="reference internal" href="configuration.html#setting-up-caching">2. Setting Up Caching</a></li>
<li class="toctree-l2"><a class="reference internal" href="configuration.html#using-a-different-environment">3. Using a Different Environment</a></li>
<li class="toctree-l2"><a class="reference internal" href="configuration.html#configuration-sources">4. Configuration Sources</a></li>
<li class="toctree-l2"><a class="reference internal" href="configuration.html#configuration-reference">5. Configuration Reference</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="errors.html">Stormpath Error Codes</a><ul>
<li class="toctree-l2"><a class="reference internal" href="errors.html#x-communication">110X: Communication</a></li>
<li class="toctree-l2"><a class="reference internal" href="errors.html#xx-billing-payment">19XX: Billing / Payment</a></li>
<li class="toctree-l2"><a class="reference internal" href="errors.html#xxx-general-validation">2XXX: General Validation</a></li>
<li class="toctree-l2"><a class="reference internal" href="errors.html#xxx-custom-data">3XXX: Custom Data</a></li>
<li class="toctree-l2"><a class="reference internal" href="errors.html#x-tenant">400X: Tenant</a></li>
<li class="toctree-l2"><a class="reference internal" href="errors.html#xxx-organization">4XXX: Organization</a></li>
<li class="toctree-l2"><a class="reference internal" href="errors.html#xxx-application">5XXX: Application</a></li>
<li class="toctree-l2"><a class="reference internal" href="errors.html#xxx-directory">6XXX: Directory</a></li>
<li class="toctree-l2"><a class="reference internal" href="errors.html#xxx-account">7XXX: Account</a></li>
<li class="toctree-l2"><a class="reference internal" href="errors.html#xxx-agent">9XXX: Agent</a></li>
<li class="toctree-l2"><a class="reference internal" href="errors.html#xx-oauth-errors">100XX: OAuth Errors</a></li>
<li class="toctree-l2"><a class="reference internal" href="errors.html#xx-saml-errors">101XX: SAML Errors</a></li>
<li class="toctree-l2"><a class="reference internal" href="errors.html#xx-token-errors">110XX: Token Errors</a></li>
<li class="toctree-l2"><a class="reference internal" href="errors.html#xx-id-site-jwt">120XX: ID Site JWT</a></li>
<li class="toctree-l2"><a class="reference internal" href="errors.html#xx-smtp-server">130XX: SMTP Server</a></li>
<li class="toctree-l2"><a class="reference internal" href="errors.html#xxx-multi-factor-authentication">13XXX: Multi-Factor Authentication</a></li>
</ul>
</li>
</ul>

            
          

  

  


        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Stormpath Python Documentation</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          













<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html">Docs</a> &raquo;</li>
        
      <li>3. Account Management</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
        
      </li>
    
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="account-management">
<span id="account-mgmt"></span><h1>3. Account Management<a class="headerlink" href="#account-management" title="Permalink to this headline">¶</a></h1>
<p>This chapter provides the information necessary for you to understand the resources and processes involved in Account Management in Stormpath. In addition to information about the different types of resources, it also contains examples of the steps required in setting up a basic user Account with membership in a Group. If you&#8217;d like to skip to those steps they are:</p>
<ol class="arabic simple">
<li><a class="reference internal" href="#make-cloud-dir"><span class="std std-ref">Creating a Directory</span></a></li>
<li><a class="reference internal" href="#make-group"><span class="std std-ref">Creating a Group</span></a></li>
<li><a class="reference internal" href="#add-new-account"><span class="std std-ref">Adding an Account to a Directory</span></a></li>
<li><a class="reference internal" href="#add-account-to-group"><span class="std std-ref">Adding our Account to a Group</span></a></li>
</ol>
<p>The final step that would allow this Account to actually log in to the application is covered in <a class="reference internal" href="auth_n.html#create-asm"><span class="std std-ref">the Authentication chapter</span></a>.</p>
<div class="section" id="modeling-your-user-base">
<h2>3.1. Modeling Your User Base<a class="headerlink" href="#modeling-your-user-base" title="Permalink to this headline">¶</a></h2>
<p>The first topic that we need to address is how user modeling works inside Stormpath.</p>
<p>User Accounts in Stormpath aren&#8217;t directly associated with Applications, but only indirectly via <strong>Directories</strong>, <strong>Organizations</strong>, and also possibly <strong>Groups</strong>.</p>
<p>All of your Accounts will have to be associated with at least one Directory resource, so you can start there.</p>
<div class="section" id="directories">
<span id="directory-mgmt"></span><h3>3.1.1. Directories<a class="headerlink" href="#directories" title="Permalink to this headline">¶</a></h3>
<p>The <strong>Directory</strong> resource is a top-level container for Account and Group resources. Directories and Groups are both referred to as &#8220;Account Stores&#8221;. A Directory also manages security policies (like password strength) for the Accounts it contains. Directories can be used to cleanly manage segmented user Account populations. For example, you might use one Directory for company employees and another Directory for customers, each with its own security policies.</p>
<div class="section" id="types-of-directories">
<h4>Types of Directories<a class="headerlink" href="#types-of-directories" title="Permalink to this headline">¶</a></h4>
<p>Stormpath supports two types of Directories:</p>
<ol class="arabic simple">
<li>Natively-hosted <strong>Cloud Directories</strong> that originate in Stormpath</li>
<li><strong>Mirror Directories</strong> that act as secure replicas of existing user directories outside of Stormpath, for example those on LDAP Directory servers, on Facebook and other websites, as well as in Identity Providers that support SAML.</li>
</ol>
<p>You can add as many Directories of each type as you require.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>Multiple Directories are a more advanced feature of Stormpath. If you have one or more applications that all access the same Accounts, you usually only need a single Directory, and you do not need to be concerned with creating or managing multiple Directories.</p>
<p class="last">If however, your application needs to support login for <a class="reference internal" href="#supporting-multiple-dirs"><span class="std std-ref">multiple external third-party accounts</span></a>, or you have more complex account segmentation needs, Directories will be a powerful tool to manage your application&#8217;s user base.</p>
</div>
</div>
<div class="section" id="cloud-directories">
<span id="about-cloud-dir"></span><h4>Cloud Directories<a class="headerlink" href="#cloud-directories" title="Permalink to this headline">¶</a></h4>
<p>This is the standard, default Directory resource.</p>
<div class="section" id="how-to-make-a-cloud-directory">
<span id="make-cloud-dir"></span><h5>How to Make a Cloud Directory<a class="headerlink" href="#how-to-make-a-cloud-directory" title="Permalink to this headline">¶</a></h5>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">directory</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">directories</span><span class="o">.</span><span class="n">create</span><span class="p">({</span>
    <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Captains&#39;</span><span class="p">,</span>
    <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="s1">&#39;Famous captains throughout history.&#39;</span><span class="p">,</span>
<span class="p">})</span>
</pre></div>
</div>
<p>At this point, our current resources (<strong>not including the default ones</strong> created in the <a class="reference internal" href="quickstart.html#quickstart"><span class="std std-ref">Quickstart</span></a>) can be visualized like this:</p>
<div class="figure align-center" id="id12">
<a class="reference internal image-reference" href="_images/am_erd_01.png"><img alt="&lt;ERD with Directory&gt;" src="_images/am_erd_01.png" style="width: 560.0px; height: 423.0px;" /></a>
<p class="caption"><span class="caption-text"><em>Our Stormpath Tenant, with an Application resource and our newly created &#8220;Captains&#8221; Directory</em></span></p>
</div>
<p>Any new Groups or Accounts that you create will have to be created inside a Directory. Before you move on to that though, it&#8217;s helpful to know a little about the other kinds of Directories available to you in Stormpath.</p>
</div>
</div>
<div class="section" id="mirror-directories">
<span id="about-mirror-dir"></span><h4>Mirror Directories<a class="headerlink" href="#mirror-directories" title="Permalink to this headline">¶</a></h4>
<p><strong>Mirror Directories</strong> are all Directories that pull-in data from external user databases. Currently this encompasses:</p>
<ul class="simple">
<li>LDAP Directories, including Active Directory</li>
<li>Social Directories, such as Facebook and GitHub</li>
<li>SAML-enabled Identity Provider Directories, such as Salesforce and OneLogin</li>
</ul>
<p>For all Mirror Directories, since the relationship with the outside directory is read-only, the remote directory is still the &#8220;system of record&#8221;. This means that you cannot do things like create your own Groups, only read the Groups (if any) synchronized from the external directory.</p>
<p id="supporting-multiple-dirs"><strong>Supporting Multiple Mirror Directories</strong></p>
<p>It is possible to use different kinds of Directories simultaneously, to allow users to log-in with multiple external systems at the same time. For example, if you wanted to enable logging-in with Facebook, LinkedIn, and Salesforce, this would require a separate Mirror Directory for each one.</p>
<p>If multiple Directories are desired, we recommend that you create a separate &#8220;master&#8221; Directory that allows for a unified user identity. This master Directory would link all the Accounts in Mirror Directories with a master Account in a master Directory.</p>
<p>For information about how login works with master Directories, please see <a class="reference internal" href="#account-linking"><span class="std std-ref">3.8. Account Linking</span></a>.</p>
<div class="section" id="ldap-directories">
<span id="about-ldap-dir"></span><h5>LDAP Directories<a class="headerlink" href="#ldap-directories" title="Permalink to this headline">¶</a></h5>
<p>LDAP Directories are a big benefit to Stormpath customers who need LDAP directory accounts to be able to securely log in to public web applications without breaking corporate firewall policies. Here is how they work:</p>
<ul class="simple">
<li>After creating an LDAP Directory in Stormpath, you download a Stormpath Agent. This is a simple standalone software application that you install behind the corporate firewall so it can communicate directly with the LDAP server.</li>
<li>You configure the agent via LDAP filters to view only the accounts that you want to expose to your Stormpath-enabled applications.</li>
<li>The Agent will start synchronizing immediately, pushing this select data outbound to Stormpath over a TLS (HTTPS) connection.</li>
<li>The synchronized user Accounts and Groups appear in the Stormpath Directory. The Accounts will be able to log in to any Stormpath-enabled application that you assign.</li>
<li>When the Agent detects local LDAP changes, additions or deletions to these specific Accounts or Groups, it will automatically propagate those changes to Stormpath to be reflected by your Stormpath-enabled applications.</li>
</ul>
<p>User Accounts and Groups in LDAP directories are automatically deleted when any of the following things happen:</p>
<ul class="simple">
<li>The original object is deleted from the LDAP directory service.</li>
<li>The original LDAP object information no longer matches the account filter criteria configured for the agent.</li>
<li>The LDAP directory is deleted.</li>
</ul>
<p>The big benefit is that your Stormpath-enabled applications still use the same convenient REST API – they do not need to know anything about things like LDAP or legacy connection protocols.</p>
<div class="section" id="modeling-ldap-directories">
<span id="modeling-ldap-dirs"></span><h6>Modeling LDAP Directories<a class="headerlink" href="#modeling-ldap-directories" title="Permalink to this headline">¶</a></h6>
<p>As Mirror Directories, LDAP Directories must have the same structure as the external LDAP directories that they are synchronizing with.</p>
<p>The Stormpath Agent is regularly updating its LDAP Directory and sometimes adding new user Accounts and/or Groups. Because this data can be quite fluid, we recommend initiating all provisioning, linking, and synchronization on a successful login attempt of the Account in the LDAP Directory. This means that the master Directory would start off empty, and would then gradually become populated every time a user logged in.</p>
<p>For more information on how to this works, please see <a class="reference internal" href="auth_n.html#ldap-dir-authn"><span class="std std-ref">4.4. Authenticating Against an LDAP Directory</span></a>.</p>
</div>
<div class="section" id="how-to-make-an-ldap-directory">
<span id="make-ldap-dir"></span><h6>How to Make an LDAP Directory<a class="headerlink" href="#how-to-make-an-ldap-directory" title="Permalink to this headline">¶</a></h6>
<p>LDAP Directories can be made using the Stormpath Admin Console, or using the Python SDK. If you&#8217;d like to do it with the Admin Console, please see <a class="reference external" href="http://docs.stormpath.com/console/product-guide/latest/directories.html#create-a-directory">the Directory Creation section of the Admin Console Guide</a>.</p>
<p>Here&#8217;s how you can create an LDAP Directory:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">directory</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">directories</span><span class="o">.</span><span class="n">create</span><span class="p">({</span>
    <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Captains&#39;</span><span class="p">,</span>
    <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="s1">&#39;Famous captains throughout history.&#39;</span><span class="p">,</span>
    <span class="s1">&#39;provider&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;provider_id&#39;</span><span class="p">:</span> <span class="s1">&#39;ldap&#39;</span><span class="p">,</span>
        <span class="s1">&#39;agent&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;config&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;directory_host&#39;</span><span class="p">:</span> <span class="s1">&#39;ldap.local&#39;</span><span class="p">,</span>
                <span class="s1">&#39;directory_port&#39;</span><span class="p">:</span> <span class="s1">&#39;666&#39;</span><span class="p">,</span>
                <span class="s1">&#39;ssl_required&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>
                <span class="s1">&#39;agent_user_dn&#39;</span><span class="p">:</span> <span class="s1">&#39;captain@america.com&#39;</span><span class="p">,</span>
                <span class="s1">&#39;agent_user_dn_password&#39;</span><span class="p">:</span> <span class="s1">&#39;americaIStheb3st!!&#39;</span><span class="p">,</span>
                <span class="s1">&#39;base_dn&#39;</span><span class="p">:</span> <span class="s1">&#39;dc=example,dc=com&#39;</span><span class="p">,</span>
                <span class="s1">&#39;poll_interval&#39;</span><span class="p">:</span> <span class="mi">60</span><span class="p">,</span>
                <span class="s1">&#39;account_config&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s1">&#39;dn_suffix&#39;</span><span class="p">:</span> <span class="s1">&#39;ou=employees&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;object_class&#39;</span><span class="p">:</span> <span class="s1">&#39;person&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;object_filter&#39;</span><span class="p">:</span> <span class="s1">&#39;(cn=finance)&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;email_rdn&#39;</span><span class="p">:</span> <span class="s1">&#39;email&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;given_name_rdn&#39;</span><span class="p">:</span> <span class="s1">&#39;givenName&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;middle_name_rdn&#39;</span><span class="p">:</span> <span class="s1">&#39;middleName&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;surname_rdn&#39;</span><span class="p">:</span> <span class="s1">&#39;sn&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;username_rdn&#39;</span><span class="p">:</span> <span class="s1">&#39;uid&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;password_rdn&#39;</span><span class="p">:</span> <span class="s1">&#39;userPassword&#39;</span><span class="p">,</span>
                <span class="p">},</span>
                <span class="s1">&#39;group_config&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s1">&#39;dn_suffix&#39;</span><span class="p">:</span> <span class="s1">&#39;ou=groups&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;object_class&#39;</span><span class="p">:</span> <span class="s1">&#39;groupOfUniqueNames&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;object_filter&#39;</span><span class="p">:</span> <span class="s1">&#39;(ou=*-group)&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;name_rdn&#39;</span><span class="p">:</span> <span class="s1">&#39;cn&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;description_rdn&#39;</span><span class="p">:</span> <span class="s1">&#39;description&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;members_rdn&#39;</span><span class="p">:</span> <span class="s1">&#39;uniqueMember&#39;</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">})</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="social-directories">
<span id="about-social-dir"></span><h5>Social Directories<a class="headerlink" href="#social-directories" title="Permalink to this headline">¶</a></h5>
<p>Stormpath works with user Accounts pulled from social login providers (currently Google, Facebook, Github, and LinkedIn) in a way very similar to the way it works with user Accounts from LDAP servers. These external social login providers are modeled as Stormpath Directories, much like LDAP Directories. The difference is that, while LDAP Directories always come with an Agent that takes care of synchronization, Social Directories have an associated <strong>Provider</strong> resource. This resource contains the information required by the social login site to work with their site (e.g. the App ID for your Google application).</p>
<p>Stormpath also simplifies the authorization process by doing things like automating Google&#8217;s access token exchange flow. All you do is POST the authorization code from the end-user and Stormpath returns a new or updated user Account, along with the Google access token which you can use for any further API calls.</p>
<div class="section" id="modeling-social-directories">
<h6>Modeling Social Directories<a class="headerlink" href="#modeling-social-directories" title="Permalink to this headline">¶</a></h6>
<p>Modeling your users who authorize via Social Login is by necessity very simple, since social login providers do not include the concept of &#8220;groups&#8221; of users in the same way that LDAP directories do. The only thing that you really have to do as an app developer is create a Directory resource for each social provider that you want to support. As mentioned <a class="reference internal" href="#supporting-multiple-dirs"><span class="std std-ref">above</span></a>, if you want to support multiple Directories then you may also want to create a master Directory for your application. For more about how Social Directories are provisioned, please see <a class="reference internal" href="#account-linking"><span class="std std-ref">3.8. Account Linking</span></a>.</p>
</div>
<div class="section" id="how-to-make-a-social-directory">
<h6>How to Make a Social Directory<a class="headerlink" href="#how-to-make-a-social-directory" title="Permalink to this headline">¶</a></h6>
<p>Social Directories can be made using the Stormpath Admin Console, or using the Python SDK. For more information about creating them with the Admin Console please see the <a class="reference external" href="http://docs.stormpath.com/console/product-guide/latest/directories.html#create-a-directory">Directories section of the Stormpath Admin Console Guide</a>.</p>
<p>For more information about creating them using the Python SDK, please see <a class="reference internal" href="auth_n.html#social-authn"><span class="std std-ref">4.3. How Social Authentication Works</span></a>.</p>
</div>
</div>
<div class="section" id="saml-directories">
<span id="about-saml-dir"></span><h5>SAML Directories<a class="headerlink" href="#saml-directories" title="Permalink to this headline">¶</a></h5>
<p>In addition to Social Login and LDAP, Stormpath also allows your users to log-in with SAML Identity Providers. Just like with Social Directories, SAML Directories are configured via an associated Provider resource that contains the configuration information for the Identity Provider.</p>
<div class="section" id="modeling-saml-directories">
<h6>Modeling SAML Directories<a class="headerlink" href="#modeling-saml-directories" title="Permalink to this headline">¶</a></h6>
<p>The only modeling considerations for SAML Directories are: you will need a Directory for each SAML IdP that you want to support, and you might need to consider having a <a class="reference internal" href="#supporting-multiple-dirs"><span class="std std-ref">Master Directory</span></a> to co-ordinate among your multiple directories.</p>
</div>
<div class="section" id="how-to-make-a-saml-directory">
<h6>How to Make a SAML Directory<a class="headerlink" href="#how-to-make-a-saml-directory" title="Permalink to this headline">¶</a></h6>
<p>SAML Directories can be made using the <a class="reference internal" href="auth_n.html#saml-configuration"><span class="std std-ref">Stormpath Admin Console</span></a> or the Python SDK.</p>
<p>For more information about creating them using the Python SDK, see <a class="reference internal" href="auth_n.html#saml-configuration-rest"><span class="std std-ref">4.5.3. Configuring SAML via REST</span></a>.</p>
</div>
</div>
</div>
</div>
<div class="section" id="groups">
<span id="group-mgmt"></span><h3>3.1.2. Groups<a class="headerlink" href="#groups" title="Permalink to this headline">¶</a></h3>
<p>The other type of Account Store is the Group resource, which can either be imagined as a container for Accounts, or as a label applied to them. Groups can be used in a variety of ways, including organizing people by geographic location, or by their role within a company.</p>
<p>Here&#8217;s how you can create a Group:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">group</span> <span class="o">=</span> <span class="n">captains_directory</span><span class="o">.</span><span class="n">groups</span><span class="o">.</span><span class="n">create</span><span class="p">({</span>
    <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Starfleet Officers&#39;</span><span class="p">,</span>
    <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="s1">&#39;A group of high ranking officers.&#39;</span><span class="p">,</span>
<span class="p">})</span>
</pre></div>
</div>
<div class="section" id="modeling-user-hierarchies-using-groups">
<span id="hierarchy-groups"></span><h4>Modeling User Hierarchies Using Groups<a class="headerlink" href="#modeling-user-hierarchies-using-groups" title="Permalink to this headline">¶</a></h4>
<p>Groups, like labels, are inherently &#8220;flat&#8221;. This means that they do not by default include any kind of hierarchy. If a hierarchical or nested structure is desired, it can be simulated in one of two ways: Either, using the Group resource&#8217;s <code class="docutils literal"><span class="pre">description</span></code> field, or with the Group&#8217;s associated customData resource.</p>
<p>A geographical region can, for example, be represented as <code class="docutils literal"><span class="pre">&quot;North</span> <span class="pre">America/US/US</span> <span class="pre">East&quot;</span></code> in the Group&#8217;s <code class="docutils literal"><span class="pre">description</span></code> field, allowing for queries to be made using simple pattern-matching queries. So to find all Groups in the US, you&#8217;d make the following request:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">groups</span> <span class="o">=</span> <span class="n">directory</span><span class="o">.</span><span class="n">groups</span><span class="o">.</span><span class="n">search</span><span class="p">({</span><span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="s1">&#39;*US*&#39;</span><span class="p">})</span>
</pre></div>
</div>
<p>Or, to find all Groups in the US East region only, you would send this request:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">groups</span> <span class="o">=</span> <span class="n">directory</span><span class="o">.</span><span class="n">groups</span><span class="o">.</span><span class="n">search</span><span class="p">({</span><span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="s1">&#39;*US East*&#39;</span><span class="p">})</span>
</pre></div>
</div>
<p>It can also be included in the customData resource, as a series of key-value relations.</p>
</div>
<div class="section" id="how-to-create-a-group">
<span id="make-group"></span><h4>How to Create a Group<a class="headerlink" href="#how-to-create-a-group" title="Permalink to this headline">¶</a></h4>
<p>So let&#8217;s say you want to add a new Group resource with the name &#8220;Starfleet Officers&#8221; to the &#8220;Captains&#8221; Directory.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Although in this example we use the Directory&#8217;s <cite>/groups</cite> endpoint, it is also possible to use an Application or Organization&#8217;s <cite>/groups</cite> endpoint. For more information see <a class="reference internal" href="#add-to-app-or-org"><span class="std std-ref">below</span></a>.</p>
</div>
<p>You would do this by issuing the following request:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">group</span> <span class="o">=</span> <span class="n">captains_directory</span><span class="o">.</span><span class="n">groups</span><span class="o">.</span><span class="n">create</span><span class="p">({</span>
    <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Starfleet Officers&#39;</span><span class="p">,</span>
    <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="s1">&#39;A group of high ranking officers.&#39;</span><span class="p">,</span>
<span class="p">})</span>
</pre></div>
</div>
<p>You can now see how this Group would look in our Tenant:</p>
<div class="figure align-center">
<a class="reference internal image-reference" href="_images/am_erd_02.png"><img alt="&lt;ERD with Directory and Group&gt;" src="_images/am_erd_02.png" style="width: 553.0px; height: 418.0px;" /></a>
</div>
<p>There is our Application, Directory, and our newly-created Group, and they are all found inside the Stormpath Tenant.</p>
</div>
</div>
</div>
<div class="section" id="how-to-store-accounts-in-stormpath">
<span id="account-creation"></span><h2>3.2. How to Store Accounts in Stormpath<a class="headerlink" href="#how-to-store-accounts-in-stormpath" title="Permalink to this headline">¶</a></h2>
<p>The Account resource is a unique identity within your application. It is usually used to model an end-user, although it can also be used by a service, process, or any other entity that needs to log-in to Stormpath.</p>
<div class="section" id="new-account-creation">
<h3>3.2.1. New Account Creation<a class="headerlink" href="#new-account-creation" title="Permalink to this headline">¶</a></h3>
<p>The basic steps for creating a new Account are covered in the <a class="reference internal" href="quickstart.html#quickstart"><span class="std std-ref">Quickstart</span></a> chapter. In that example, we show you how to add an Account to an Application. Below, we will also show you how to add an Account to a specific Directory, or Group.</p>
<div class="section" id="add-a-new-account-to-a-directory">
<span id="add-new-account"></span><h4>Add a New Account to a Directory<a class="headerlink" href="#add-a-new-account-to-a-directory" title="Permalink to this headline">¶</a></h4>
<p>Because Accounts are &#8220;owned&#8221; by Directories, you create new Accounts by adding them to a Directory. You can add an Account to a Directory directly, or you can add it indirectly by registering an Account with an Application, like in the <a class="reference internal" href="quickstart.html#quickstart"><span class="std std-ref">Quickstart</span></a>, or an Organization, like in <a class="reference internal" href="multitenancy.html#add-accnt-to-org"><span class="std std-ref">the Multi-tenancy Chapter</span></a>. This is only the case for Cloud Directories. Accounts cannot be directly added to <a class="reference internal" href="#about-mirror-dir"><span class="std std-ref">Mirror</span></a> Directories since those pull all of their Account information from external sources like Facebook or Active Directory.</p>
<p>Let&#8217;s say you want to add a new Account for user &#8220;Jean-Luc Picard&#8221; to the &#8220;Captains&#8221; Directory that you created earlier. You can do this like so:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">jean_luc</span> <span class="o">=</span> <span class="n">captains_directory</span><span class="o">.</span><span class="n">accounts</span><span class="o">.</span><span class="n">create</span><span class="p">({</span>
    <span class="s1">&#39;username&#39;</span><span class="p">:</span> <span class="s1">&#39;jlpicard&#39;</span><span class="p">,</span>
    <span class="s1">&#39;given_name&#39;</span><span class="p">:</span> <span class="s1">&#39;Jean-Luc&#39;</span><span class="p">,</span>
    <span class="s1">&#39;surname&#39;</span><span class="p">:</span> <span class="s1">&#39;Picard&#39;</span><span class="p">,</span>
    <span class="s1">&#39;email&#39;</span><span class="p">:</span> <span class="s1">&#39;capt@enterprise.com&#39;</span><span class="p">,</span>
    <span class="s1">&#39;password&#39;</span><span class="p">:</span> <span class="s1">&#39;uGhd%a8Kl!&#39;</span><span class="p">,</span>
<span class="p">})</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>The password in the request is being sent to Stormpath as plain text. This is one of the reasons why Stormpath only allows requests via HTTPS. Stormpath implements the latest password hashing and cryptographic best-practices that are automatically upgraded over time so the developer does not have to worry about this. Stormpath can only do this for the developer if you receive the password as plaintext, and only hash it using these techniques.</p>
<p>Plaintext passwords also allow Stormpath to enforce password restrictions in a configurable manner.</p>
<p>Most importantly, Stormpath never persists or relays plaintext passwords under any circumstances.</p>
<p class="last">On the client side, then, you do not need to worry about salting or storing passwords at any point; you need only pass them to Stormpath for hashing, salting, and persisting with the appropriate HTTPS API call.</p>
</div>
<p>Going back to our resource diagram:</p>
<div class="figure align-center">
<a class="reference internal image-reference" href="_images/am_erd_03.png"><img alt="ERD with groupMembership" src="_images/am_erd_03.png" style="width: 551.0px; height: 418.0px;" /></a>
</div>
<p>The new Account is now in the &#8220;Captains&#8221; Directory.</p>
</div>
<div class="section" id="add-an-existing-account-to-a-group">
<span id="add-account-to-group"></span><h4>Add an Existing Account to a Group<a class="headerlink" href="#add-an-existing-account-to-a-group" title="Permalink to this headline">¶</a></h4>
<p>So let&#8217;s say you want to add &#8220;Jean-Luc Picard&#8221; to the &#8220;Starfleet Officers&#8221; Group inside the &#8220;Captains&#8221; Directory. Once again, this is possible because we are working with a Cloud Directory. If we were working with a <a class="reference internal" href="#about-mirror-dir"><span class="std std-ref">Mirror Directory</span></a>, we would not be able to manually add Groups since that information is pulled from the external user directory.</p>
<p>This time, use the existing Account instance you created before, like so:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">jean_luc</span><span class="o">.</span><span class="n">add_group</span><span class="p">(</span><span class="n">group</span><span class="p">)</span>
</pre></div>
</div>
<p>This would leave us with the following resources:</p>
<div class="figure align-center">
<a class="reference internal image-reference" href="_images/am_erd_final.png"><img alt="Final ERD" src="_images/am_erd_final.png" style="width: 581.0px; height: 449.0px;" /></a>
</div>
<p>This our completed resource set, with an Account that is a member of a Group inside a Directory. That Directory, along with the Application, sit inside the Stormpath Tenant. Notice, however, that there is no association between the Application and the Directory. For more information about this, please see <a class="reference internal" href="auth_n.html#create-asm"><span class="std std-ref">the Authentication chapter</span></a>.</p>
</div>
<div class="section" id="adding-a-new-account-or-group-to-an-application-or-organization">
<span id="add-to-app-or-org"></span><h4>Adding a new Account or Group to an Application or Organization<a class="headerlink" href="#adding-a-new-account-or-group-to-an-application-or-organization" title="Permalink to this headline">¶</a></h4>
<p>Instead of adding an Account via the Directory&#8217;s <code class="docutils literal"><span class="pre">/accounts</span></code> endpoint, it is also possible to use an Application&#8217;s <code class="docutils literal"><span class="pre">/accounts</span></code> endpoint:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">POST</span> <span class="o">/</span><span class="n">v1</span><span class="o">/</span><span class="n">applications</span><span class="o">/</span><span class="mi">1</span><span class="n">gk4Dxzi6o4Pbdlexample</span><span class="o">/</span><span class="n">accounts</span> <span class="n">HTTP</span><span class="o">/</span><span class="mf">1.1</span>
</pre></div>
</div>
<p>Or the same endpoint found on an Organization:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">POST</span> <span class="o">/</span><span class="n">v1</span><span class="o">/</span><span class="n">organizations</span><span class="o">/</span><span class="mi">2</span><span class="n">P4XOanz26AUomIexample</span><span class="o">/</span><span class="n">accounts</span> <span class="n">HTTP</span><span class="o">/</span><span class="mf">1.1</span>
</pre></div>
</div>
<p>This will then add the Account to the Directory that is set as that Application or Organization&#8217;s <strong>Default Account Store</strong>. What this means is that Stormpath will go through the Application/Organization&#8217;s list of Account Store Mappings (found in the <code class="docutils literal"><span class="pre">/accountStoreMappings</span></code> collection) and find the Account Store Mapping where <code class="docutils literal"><span class="pre">isDefaultAccountStore</span></code> is set to <code class="docutils literal"><span class="pre">true</span></code>. The Account will then be added to that Account Store.</p>
<p>All of this is also true for adding Groups, except in that case you would use the <code class="docutils literal"><span class="pre">/groups</span></code> endpoint and Stormpath would add the Group to the Account Store Mapping that had <code class="docutils literal"><span class="pre">isDefaultGroupStore</span></code> set to <code class="docutils literal"><span class="pre">true</span></code>.</p>
</div>
</div>
<div class="section" id="importing-accounts">
<span id="id5"></span><h3>3.2.2. Importing Accounts<a class="headerlink" href="#importing-accounts" title="Permalink to this headline">¶</a></h3>
<p>Stormpath also makes it very easy to transfer your existing users into a Stormpath Directory using our API. Depending on how you store your passwords, you will use one of three approaches:</p>
<ol class="arabic simple">
<li><strong>Plaintext Passwords:</strong> If your stored passwords in plaintext, you can use the Stormpath API to import them directly. Stormpath will create the Accounts and secure their passwords automatically (within our system). Make sure that your Stormpath Directory is configured to <em>not</em> send Account Verification emails before beginning import.</li>
<li><strong>Supported Password Hashes:</strong> If your password hashing algorithm follows a format Stormpath supports, you can use the API to import Accounts directly using Modular Crypt Format (MCF). Supported formats and instructions are detailed <a class="reference internal" href="#importing-mcf"><span class="std std-ref">below</span></a>.</li>
<li><strong>Unsupported Password Hashes:</strong> If your password hashes are in a format Stormpath does not support, you can still use the API to create the Accounts, but you will need to issue a password reset afterwards. Otherwise, your users won&#8217;t be able to to log in.</li>
</ol>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">To import user accounts from an LDAP or Social Directory, please see <a class="reference internal" href="#account-linking"><span class="std std-ref">3.8. Account Linking</span></a>.</p>
</div>
<p>Due to the sheer number of database types and the variation between individual data models, the actual importing of users is not something that Stormpath handles at this time. What we recommend is that you write a script that is able to iterate through your database and grab the necessary information. Then the script can use our API to upload the users to Stormpath.</p>
<div class="section" id="importing-accounts-with-plaintext-passwords">
<h4>Importing Accounts with Plaintext Passwords<a class="headerlink" href="#importing-accounts-with-plaintext-passwords" title="Permalink to this headline">¶</a></h4>
<p>In this case, it is recommended that you suppress Account Verification emails.</p>
<p>This can be done by setting the <code class="docutils literal"><span class="pre">registration_workflow_enabled</span></code> flag when creating the Account:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">account</span> <span class="o">=</span> <span class="n">directory</span><span class="o">.</span><span class="n">accounts</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">account_data</span><span class="p">,</span> <span class="n">registration_workflow_enabled</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="importing-accounts-with-supported-password-hashes">
<span id="importing-mcf"></span><h4>Importing Accounts with Supported Password Hashes<a class="headerlink" href="#importing-accounts-with-supported-password-hashes" title="Permalink to this headline">¶</a></h4>
<p>You can import existing hashed passwords <em>only if</em> the hashing format is one that Stormpath supports:</p>
<ul class="simple">
<li><strong>bcrypt</strong>: Stormpath supports importing bcrypt hashes directly. These password hashes have the identifier prefix <code class="docutils literal"><span class="pre">$2a$</span></code>, <code class="docutils literal"><span class="pre">$2b$</span></code>, or <code class="docutils literal"><span class="pre">$2x$</span></code>.</li>
<li><strong>MD5 or SHA</strong>: Stormpath supports hahes generated with MD5 and SHA. You must create an MCF string with the prefix <code class="docutils literal"><span class="pre">$stormpath2$</span></code> as detailed <a class="reference internal" href="#stormpath2-hash"><span class="std std-ref">below</span></a>.</li>
</ul>
<p>In both cases, once you have an MCF-compatible string that represents the password hash, you can create an Account in Stormpath.</p>
<p>This can be done by setting the <code class="docutils literal"><span class="pre">password_format</span></code> option when creating the Account:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">account</span> <span class="o">=</span> <span class="n">directory</span><span class="o">.</span><span class="n">accounts</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">account_data</span><span class="p">,</span> <span class="n">password_format</span><span class="o">=</span><span class="s1">&#39;mcf&#39;</span><span class="p">,</span> <span class="n">registration_workflow_enabled</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</pre></div>
</div>
<p>Once the Account is created, Stormpath will use the password hash to authenticate the Account’s <strong>first</strong> login attempt. If the first login attempt is successful, Stormpath will recreate the password hash using a secure HMAC algorithm.</p>
<div class="section" id="the-stormpath2-format">
<span id="stormpath2-hash"></span><h5>The stormpath2 Format<a class="headerlink" href="#the-stormpath2-format" title="Permalink to this headline">¶</a></h5>
<p>If your passwords are hashed with MD5 or SHA, you can import them by creating a <code class="docutils literal"><span class="pre">$</span></code>-delimited MCF string that describes the hashing algorithm and parameters. The string should be prefixed with the token <code class="docutils literal"><span class="pre">$stormpath2</span></code> and must follow this format:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>$stormpath2$ALGORITHM_NAME$ITERATION_COUNT$BASE64_SALT$BASE64_PASSWORD_HASH
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="33%" />
<col width="33%" />
<col width="33%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Property</th>
<th class="head">Description</th>
<th class="head">Valid Values</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><code class="docutils literal"><span class="pre">ALGORITHM_NAME</span></code></td>
<td>The name of the hashing algorithm used to generate the <code class="docutils literal"><span class="pre">BASE64_PASSWORD_HASH</span></code>.</td>
<td><code class="docutils literal"><span class="pre">MD5</span></code>, <code class="docutils literal"><span class="pre">SHA-1</span></code>, <code class="docutils literal"><span class="pre">SHA-256</span></code>, <code class="docutils literal"><span class="pre">SHA-384</span></code>, <code class="docutils literal"><span class="pre">SHA-512</span></code></td>
</tr>
<tr class="row-odd"><td><code class="docutils literal"><span class="pre">ITERATION_COUNT</span></code></td>
<td>The number of iterations executed when generating the <code class="docutils literal"><span class="pre">BASE64_PASSWORD_HASH</span></code></td>
<td>Number &gt; 0</td>
</tr>
<tr class="row-even"><td><code class="docutils literal"><span class="pre">BASE64_SALT</span></code></td>
<td>The salt byte array used to salt the first hash iteration.</td>
<td>String (Base64). If your password hashes do not have salt, you can omit it entirely.</td>
</tr>
<tr class="row-odd"><td><code class="docutils literal"><span class="pre">BASE64_PASSWORD_HASH</span></code></td>
<td>The computed hash byte array.</td>
<td>String (Base64)</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="section" id="importing-accounts-with-unsupported-password-hashes">
<h4>Importing Accounts with Unsupported Password Hashes<a class="headerlink" href="#importing-accounts-with-unsupported-password-hashes" title="Permalink to this headline">¶</a></h4>
<p>If your passwords are hashed in a format that Stormpath does not support, you&#8217;re not out of luck. You can still import your users into Stormpath, with an additional step:</p>
<ol class="arabic simple">
<li>Create the Account and set the password to a large randomly-generated string.</li>
<li>Prompt the user to complete the password reset workflow. For more information, please see the <a class="reference internal" href="#password-reset-flow"><span class="std std-ref">Password Reset section below</span></a>.</li>
</ol>
</div>
</div>
<div class="section" id="how-to-store-additional-user-information-as-custom-data">
<span id="add-user-customdata"></span><h3>3.2.3. How to Store Additional User Information as Custom Data<a class="headerlink" href="#how-to-store-additional-user-information-as-custom-data" title="Permalink to this headline">¶</a></h3>
<p>While Stormpath’s default Account attributes are useful to many applications, you might want to add your own Custom Data to a Stormpath Account. If you want, you can store all of your custom account information in Stormpath so you don’t have to maintain another separate database to store your specific account data.</p>
<p>Custom Data can store:</p>
<ul class="simple">
<li>String values</li>
<li>Boolean values</li>
<li>Number values</li>
<li>Arrays</li>
<li>JSON Objects (with nesting)</li>
</ul>
<p>One simple use case for Custom Data could be if you wanted to add information to our &#8220;Jean-Luc Picard&#8221; Account that didn&#8217;t fit into any of the existing Account attributes.</p>
<p>For example, you could add information about this user&#8217;s current location, like the ship this Captain is currently assigned to.</p>
<p>The <code class="docutils literal"><span class="pre">jean_luc</span></code> Account you created earlier has a <code class="docutils literal"><span class="pre">custom_data</span></code> property that allows you to write to the resource&#8217;s Custom Data:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">jean_luc</span><span class="o">.</span><span class="n">custom_data</span><span class="p">[</span><span class="s1">&#39;current_assignment&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;USS Enterprise (NCC-1701-E)&#39;</span>
<span class="n">jean_luc</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
</pre></div>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">Any Custom Data changes you make are not preserved until you call <code class="docutils literal"><span class="pre">save()</span></code> on the Account resource to send the updates to the Stormpath API.</p>
</div>
</div>
</div>
<div class="section" id="how-to-search-accounts">
<span id="howto-search-accounts"></span><h2>3.3. How to Search Accounts<a class="headerlink" href="#how-to-search-accounts" title="Permalink to this headline">¶</a></h2>
<p>You can search Stormpath Accounts, just like all Resource collections, using Filter, Attribute, and Datetime search.</p>
<p>The Account resource&#8217;s <strong>searchable attributes</strong> are:</p>
<blockquote>
<div><ul class="simple">
<li><code class="docutils literal"><span class="pre">givenName</span></code></li>
<li><code class="docutils literal"><span class="pre">middleName</span></code></li>
<li><code class="docutils literal"><span class="pre">surname</span></code></li>
<li><code class="docutils literal"><span class="pre">username</span></code></li>
<li><code class="docutils literal"><span class="pre">email</span></code></li>
<li><code class="docutils literal"><span class="pre">status</span></code></li>
</ul>
</div></blockquote>
<p>Any resource type that exposes an <code class="docutils literal"><span class="pre">accounts</span></code> collection (such as Applications, Directories, Groups, and Organizations) can be searched for Accounts.</p>
<div class="section" id="example-account-searches">
<h3>3.3.1. Example Account Searches<a class="headerlink" href="#example-account-searches" title="Permalink to this headline">¶</a></h3>
<p>Below are some examples of different kinds of searches that can be performed to find Accounts.</p>
<div class="section" id="search-an-application-s-accounts-for-a-particular-word">
<h4>Search an Application&#8217;s Accounts for a Particular Word<a class="headerlink" href="#search-an-application-s-accounts-for-a-particular-word" title="Permalink to this headline">¶</a></h4>
<p>A Filter search will locate the specified string in any searchable attribute of any Account associated with this Application:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">accounts</span> <span class="o">=</span> <span class="n">application</span><span class="o">.</span><span class="n">accounts</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s1">&#39;luc&#39;</span><span class="p">)</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Matching is case-insensitive, so <code class="docutils literal"><span class="pre">.search('luc')</span></code> and <code class="docutils literal"><span class="pre">.search('Luc')</span></code> will return the same results.</p>
</div>
</div>
<div class="section" id="find-all-the-disabled-accounts-in-a-directory">
<h4>Find All the Disabled Accounts in a Directory<a class="headerlink" href="#find-all-the-disabled-accounts-in-a-directory" title="Permalink to this headline">¶</a></h4>
<p>An <a class="reference internal" href="reference.html#search-attribute"><span class="std std-ref">Attribute Search</span></a> can be used on a Directory&#8217;s Accounts collection in order to find all of the Accounts that contain a certain value in the specified attribute.</p>
<p>For example, this could be used to find all the Accounts that are disabled (i.e. that have their <code class="docutils literal"><span class="pre">status</span></code> set to <code class="docutils literal"><span class="pre">disabled</span></code>).</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">accounts</span> <span class="o">=</span> <span class="n">application</span><span class="o">.</span><span class="n">accounts</span><span class="o">.</span><span class="n">search</span><span class="p">({</span><span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;DISABLED&#39;</span><span class="p">})</span>
</pre></div>
</div>
</div>
<div class="section" id="find-all-accounts-in-a-directory-that-were-modified-on-a-particular-day">
<h4>Find All Accounts in a Directory That Were Modified on a Particular Day<a class="headerlink" href="#find-all-accounts-in-a-directory-that-were-modified-on-a-particular-day" title="Permalink to this headline">¶</a></h4>
<p>Datetime Search is used when you want to search for Accounts that have a certain point or period in time that interests you. So you could search for all of the Accounts in a Directory that were modified on Dec 1, 2015.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">accounts</span> <span class="o">=</span> <span class="n">application</span><span class="o">.</span><span class="n">accounts</span><span class="o">.</span><span class="n">search</span><span class="p">({</span><span class="s1">&#39;modified_at&#39;</span><span class="p">:</span> <span class="s1">&#39;2016-03-18&#39;</span><span class="p">})</span>

<span class="c1"># Or, if you prefer, you can search using a `date` object:</span>

<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">date</span>
<span class="n">accounts</span> <span class="o">=</span> <span class="n">application</span><span class="o">.</span><span class="n">accounts</span><span class="o">.</span><span class="n">search</span><span class="p">({</span><span class="s1">&#39;modified_at&#39;</span><span class="p">:</span> <span class="n">date</span><span class="p">(</span><span class="n">year</span><span class="o">=</span><span class="mi">2016</span><span class="p">,</span> <span class="n">month</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">day</span><span class="o">=</span><span class="mi">18</span><span class="p">)})</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="searching-for-accounts-with-custom-data">
<span id="howto-search-account-customdata"></span><h3>3.3.2. Searching for Accounts with Custom Data<a class="headerlink" href="#searching-for-accounts-with-custom-data" title="Permalink to this headline">¶</a></h3>
<p>It is also possible to retrieve a collection of Accounts by searching the data stored in their Custom Data.</p>
<p>For example, if some or all of your Accounts in a particular Directory have a Custom Data key called <code class="docutils literal"><span class="pre">startDate</span></code> that contains the date that user started using your application, you could search for the Accounts that started within a particular date range:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">accounts</span> <span class="o">=</span> <span class="n">directory</span><span class="o">.</span><span class="n">accounts</span><span class="o">.</span><span class="n">search</span><span class="p">({</span><span class="s1">&#39;customData.startDate&#39;</span><span class="p">:</span> <span class="s1">&#39;[2012,2015]&#39;</span><span class="p">})</span>
</pre></div>
</div>
<p>This query will match Accounts with a <code class="docutils literal"><span class="pre">startDate</span></code> value between <code class="docutils literal"><span class="pre">2012-01-01</span></code> and <code class="docutils literal"><span class="pre">2015-12-31</span></code>. Additionally, only the top five Accounts will be returned from the result set, with an <code class="docutils literal"><span class="pre">offset</span></code> of <code class="docutils literal"><span class="pre">0</span></code>.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">This feature is currently in beta. If you have any questions, comments, or suggestions, reach out to us at <a class="reference external" href="mailto:support&#37;&#52;&#48;stormpath&#46;com">support<span>&#64;</span>stormpath<span>&#46;</span>com</a>.</p>
</div>
</div>
</div>
<div class="section" id="how-to-manage-an-account-s-password">
<span id="managing-account-pwd"></span><h2>3.4. How to Manage an Account&#8217;s Password<a class="headerlink" href="#how-to-manage-an-account-s-password" title="Permalink to this headline">¶</a></h2>
<p>One of the major categories of user management tasks that Stormpath handles and simplifies for you is managing user passwords. All of these different use cases are discussed in the section below.</p>
<div class="section" id="manage-password-policies">
<h3>3.4.1. Manage Password Policies<a class="headerlink" href="#manage-password-policies" title="Permalink to this headline">¶</a></h3>
<p>In Stormpath, password policies are defined on a Directory level. Specifically, they are controlled in a <strong>Password Policy</strong> resource associated with the Directory. Modifying this resource also modifies the behavior of all Accounts that are included in this Directory. For more information about this resource, see the <a class="reference internal" href="reference.html#ref-password-policy"><span class="std std-ref">Password Policy section in the Reference chapter</span></a>.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">This section assumes a basic familiarity with Stormpath Workflows. For more information about Workflows, please see <a class="reference external" href="http://docs.stormpath.com/console/product-guide/latest/directories.html#set-up-workflows">the Directory Workflows section of the Admin Console Guide</a>.</p>
</div>
<p>Changing the Password Strength resource for a Directory modifies the requirement for new Accounts and password changes on existing Accounts in that Directory.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">strength</span> <span class="o">=</span> <span class="n">directory</span><span class="o">.</span><span class="n">password_policy</span><span class="o">.</span><span class="n">strength</span>

<span class="n">strength</span><span class="o">.</span><span class="n">min_length</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">strength</span><span class="o">.</span><span class="n">max_length</span> <span class="o">=</span> <span class="mi">24</span>
<span class="n">strength</span><span class="o">.</span><span class="n">min_symbol</span> <span class="o">=</span> <span class="mi">1</span>

<span class="n">strength</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="change-an-account-s-password">
<span id="change-account-pwd"></span><h3>3.4.2. Change an Account&#8217;s Password<a class="headerlink" href="#change-an-account-s-password" title="Permalink to this headline">¶</a></h3>
<p>At no point is the user shown, or does Stormpath have access to, the original password once it has been hashed during Account creation. The only ways to change an Account password once it has been created are:</p>
<ol class="arabic simple">
<li>To allow the user to update it (without seeing the original value) after being authenticated, or</li>
<li>To use the <a class="reference internal" href="#password-reset-flow"><span class="std std-ref">password reset workflow</span></a>.</li>
</ol>
<p>To update the password, you send the updated password to the Account resource:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">account</span><span class="o">.</span><span class="n">password</span> <span class="o">=</span> <span class="s1">&#39;some_New+Value1234&#39;</span>
<span class="n">account</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
</pre></div>
</div>
<p>For more information about resetting the password, read on.</p>
</div>
<div class="section" id="password-reset">
<span id="password-reset-flow"></span><h3>3.4.3. Password Reset<a class="headerlink" href="#password-reset" title="Permalink to this headline">¶</a></h3>
<p>Password Reset in Stormpath is a self-service flow, where the user is sent an email with a secure link. The user can then click that link and be shown a password reset form. The password reset workflow involves changes to an account at an application level, and as such, this workflow relies on the application resource as a starting point. While this workflow is disabled by default, you can enable it easily in the Stormpath Admin Console UI. Refer to the <a class="reference external" href="http://docs.stormpath.com/console/product-guide/latest/directories.html#password-reset">Stormpath Admin Console product guide</a> for complete instructions.</p>
<div class="section" id="how-to-reset-a-password">
<h4>How to Reset a Password<a class="headerlink" href="#how-to-reset-a-password" title="Permalink to this headline">¶</a></h4>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">A password reset will only succeed if there is an Account Store mapped to your Application. For more information about this, please see <a class="reference internal" href="auth_n.html#create-asm"><span class="std std-ref">the Authentication chapter</span></a>.</p>
</div>
<p>There are three steps to the password reset flow:</p>
<ol class="arabic simple">
<li>Trigger the workflow</li>
<li>Verify the token</li>
<li>Update the password</li>
</ol>
<p><strong>Trigger the workflow</strong></p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">application</span><span class="o">.</span><span class="n">send_password_reset_email</span><span class="p">(</span><span class="s1">&#39;phasma@empire.gov&#39;</span><span class="p">)</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>It is also possible to specify the Account Store in your Password Reset request:</p>
<div class="last highlight-python"><div class="highlight"><pre><span></span><span class="n">application</span><span class="o">.</span><span class="n">send_password_reset_email</span><span class="p">(</span><span class="s1">&#39;phasma@empire.gov&#39;</span><span class="p">,</span> <span class="n">account_store</span><span class="o">=</span><span class="n">account_store</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>If this is a valid email in an Account associated with this Application, the request will succeed.</p>
<p>At this point, an email will be built using the password reset base URL specified in the Stormpath Admin Console. Stormpath sends an email (that you <a class="reference internal" href="#password-reset-email-templates"><span class="std std-ref">can customize</span></a>) to the user with a link in the format that follows:</p>
<p><code class="docutils literal"><span class="pre">http://yoursite.com/path/to/reset/page?sptoken=$TOKEN</span></code></p>
<p>So the user would then receive something that looked like this:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>Forgot your password?

You&#39;ve received a request to reset the password for this email address.

To reset your password please click on this link or cut and paste this
URL into your browser (link expires in 24 hours):
https://api.stormpath.com/passwordReset?sptoken=eyJraWQiOiIxZ0JUbmNXc[...]

This link takes you to a secure page where you can change your password.
</pre></div>
</div>
<p><strong>Verify the token</strong></p>
<p>Once the user clicks this link, your controller should retrieve the token from the query string and check it against the Stormpath API.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">application</span><span class="o">.</span><span class="n">verify_password_reset_token</span><span class="p">(</span><span class="n">token</span><span class="p">):</span>
    <span class="c1"># The token is valid!</span>
<span class="k">else</span><span class="p">:</span>
    <span class="c1"># :(</span>
</pre></div>
</div>
<p><strong>Update the password</strong></p>
<p>After verifying that the token from the query string is valid, you can direct the user to a page where they can update their password.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">application</span><span class="o">.</span><span class="n">reset_account_password</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="s1">&#39;newPassword0HY3A!!!&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>On success, the response will include a link to the Account that the password was reset for. It will also send the password change confirmation email that was configured in the Administrator Console to the email account associated with the Account.</p>
</div>
<div class="section" id="manage-password-reset-emails">
<h4>Manage Password Reset Emails<a class="headerlink" href="#manage-password-reset-emails" title="Permalink to this headline">¶</a></h4>
<p>The Password Reset Email is configurable for a Directory.</p>
<p>There is a set of properties on the Password Policy resource that define its behavior. These properties are:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">resetEmailStatus</span></code> which enables or disables the reset email.</li>
<li><code class="docutils literal"><span class="pre">resetEmailTemplates</span></code> which defines the content of the password reset email that is sent to the Account’s email address with a link to reset the Account’s password.</li>
<li><code class="docutils literal"><span class="pre">resetSuccessEmailStatus</span></code> which enables or disables the reset success email, and</li>
<li><code class="docutils literal"><span class="pre">resetSuccessEmailTemplates</span></code> which defines the content of the reset success email.</li>
</ul>
<p>To control whether any email is sent or not is simply a matter of setting the appropriate value to either <code class="docutils literal"><span class="pre">ENABLED</span></code> or <code class="docutils literal"><span class="pre">DISABLED</span></code>. For example, if you would like a Password Reset email to be sent, perform the following:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">policy</span> <span class="o">=</span> <span class="n">directory</span><span class="o">.</span><span class="n">password_policy</span>
<span class="n">policy</span><span class="o">.</span><span class="n">reset_email_status</span> <span class="o">=</span> <span class="bp">True</span>
<span class="n">policy</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="password-reset-email-templates">
<span id="id6"></span><h4>Password Reset Email Templates<a class="headerlink" href="#password-reset-email-templates" title="Permalink to this headline">¶</a></h4>
<p>The contents of the password reset and the password reset success emails are both defined in an Email Templates collection.</p>
<p>To modify the emails that get sent during the password reset workflow, all you have to do is send an HTTP POST with the desired property in the payload body. For more information about Email Templates, see the <a class="reference external" href="https://docs.stormpath.com/rest/product-guide/latest/reference.html#ref-emailtemplates">Email Templates section</a> of the Reference chapter.</p>
</div>
</div>
<div class="section" id="how-to-find-when-an-account-s-password-was-changed">
<span id="password-change-timestamp-search"></span><h3>3.4.4. How to Find When An Account&#8217;s Password Was Changed<a class="headerlink" href="#how-to-find-when-an-account-s-password-was-changed" title="Permalink to this headline">¶</a></h3>
<p>You may want to find out when an Account&#8217;s password was last changed, or return a collection of Accounts that changed their passwords within a certain timespan. This information is contained in the searchable <code class="docutils literal"><span class="pre">passwordModifiedAt</span></code> attribute found in every Account resource.</p>
<p>If you wanted to find all Accounts that hadn&#8217;t modified their password yet in 2016 you would use <a class="reference internal" href="reference.html#search-datetime"><span class="std std-ref">Datetime search</span></a>:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">accounts</span> <span class="o">=</span> <span class="n">directory</span><span class="o">.</span><span class="n">accounts</span><span class="o">.</span><span class="n">search</span><span class="p">({</span><span class="s1">&#39;passwordModifiedAt&#39;</span><span class="p">:</span> <span class="s1">&#39;[,2016]&#39;</span><span class="p">})</span>
</pre></div>
</div>
<p>This would then return all Accounts in the specified Directory that had their passwords modified at any time between the beginning of time and the end of 2015.</p>
</div>
<div class="section" id="how-to-restrict-password-reuse">
<span id="password-reuse"></span><h3>3.4.5. How to Restrict Password Reuse<a class="headerlink" href="#how-to-restrict-password-reuse" title="Permalink to this headline">¶</a></h3>
<p>Stormpath can store historical password information in order to allow for restrictions on password reuse. This is controlled on the Directory Password Policy&#8217;s Strength object, which has an attribute called <code class="docutils literal"><span class="pre">preventReuse</span></code>. By default this feature is disabled and set to <code class="docutils literal"><span class="pre">0</span></code>. In order to enable this feature, you have to modify the Directory Password Policy&#8217;s Strength resource, sending any value up to <code class="docutils literal"><span class="pre">25</span></code>:</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p>This feature is not yet available in the Python SDK. For updates, you can follow <a class="reference external" href="https://github.com/stormpath/stormpath-sdk-python/issues/278">ticket #278</a> on Github.</p>
<p class="last">In the meantime, please use the Stormpath Admin Console UI, or consult the REST API documentation below.</p>
</div>
<div class="highlight-http"><div class="highlight"><pre><span></span><span class="nf">POST</span> <span class="nn">/v1/passwordPolicies/2SKhstu8PlaekcaEXampLE/strength</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">api.stormpath.com</span>
<span class="na">Authorization</span><span class="o">:</span> <span class="l">Basic MlpG...</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json</span>

<span class="p">{</span>
    <span class="nt">&quot;preventReuse&quot;</span><span class="p">:</span> <span class="s2">&quot;10&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">For more information on Password Policy for password Strength see <a class="reference internal" href="reference.html#ref-password-strength"><span class="std std-ref">here</span></a>.</p>
</div>
<p>This would prevent a user from choosing a password that is the same as any of their previous 10 passwords.</p>
</div>
</div>
<div class="section" id="how-to-manage-an-account-s-required-attributes">
<span id="account-schema"></span><h2>3.5. How to Manage an Account&#8217;s Required Attributes<a class="headerlink" href="#how-to-manage-an-account-s-required-attributes" title="Permalink to this headline">¶</a></h2>
<p>Every Directory has its own Account Schema. This Schema allows you to control which Account attributes (referred to as <code class="docutils literal"><span class="pre">fields</span></code> within the Account Schema) must be passed as part of new Account creation.</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">This feature is not yet available in the Python SDK. In the meantime, please consult the REST API documentation below.</p>
</div>
<div class="section" id="retrieving-your-directory-s-account-schema">
<h3>3.5.1. Retrieving your Directory&#8217;s Account Schema<a class="headerlink" href="#retrieving-your-directory-s-account-schema" title="Permalink to this headline">¶</a></h3>
<p>You will find a link to the <code class="docutils literal"><span class="pre">accountSchema</span></code> resource in your Directory:</p>
<div class="highlight-json"><div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="nt">&quot;href&quot;</span><span class="p">:</span> <span class="s2">&quot;https://api.stormpath.com/v1/directories/iusmp6mK91ZZ5example&quot;</span><span class="p">,</span>
  <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Account Schema Test&quot;</span><span class="p">,</span>
  <span class="nt">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;A Directory to test Account Schema restrictions&quot;</span><span class="p">,</span>
  <span class="nt">&quot;...&quot;</span><span class="p">:</span> <span class="s2">&quot;...&quot;</span><span class="p">,</span>
  <span class="nt">&quot;accountSchema&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&quot;href&quot;</span><span class="p">:</span> <span class="s2">&quot;https://api.stormpath.com/v1/schemas/ivVhIkQVLGSLnExample&quot;</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>You can send a <code class="docutils literal"><span class="pre">GET</span></code> to that URL, with an <code class="docutils literal"><span class="pre">expand</span></code> parameter for the <code class="docutils literal"><span class="pre">fields</span></code> collection:</p>
<div class="highlight-http"><div class="highlight"><pre><span></span><span class="nf">GET</span> <span class="nn">/v1/schemas/ivVhIkQVLGSLnExample?expand=fields</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">api.stormpath.com</span>
<span class="na">Authorization</span><span class="o">:</span> <span class="l">Basic MlpG...</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json</span>
</pre></div>
</div>
<p>And get back the Account Schema:</p>
<div class="highlight-json"><div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="nt">&quot;href&quot;</span><span class="p">:</span> <span class="s2">&quot;https://api.stormpath.com/v1/schemas/ivVhIkQVLGSLnLexample&quot;</span><span class="p">,</span>
  <span class="nt">&quot;createdAt&quot;</span><span class="p">:</span> <span class="s2">&quot;2016-08-19T19:42:41.961Z&quot;</span><span class="p">,</span>
  <span class="nt">&quot;modifiedAt&quot;</span><span class="p">:</span> <span class="s2">&quot;2016-08-19T19:42:41.961Z&quot;</span><span class="p">,</span>
  <span class="nt">&quot;fields&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&quot;href&quot;</span><span class="p">:</span> <span class="s2">&quot;https://api.stormpath.com/v1/schemas/ivVhIkQVLGSLnLexample/fields&quot;</span><span class="p">,</span>
    <span class="nt">&quot;offset&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="nt">&quot;limit&quot;</span><span class="p">:</span> <span class="mi">25</span><span class="p">,</span>
    <span class="nt">&quot;size&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
    <span class="nt">&quot;items&quot;</span><span class="p">:</span> <span class="p">[</span>
      <span class="p">{</span>
        <span class="nt">&quot;href&quot;</span><span class="p">:</span> <span class="s2">&quot;https://api.stormpath.com/v1/fields/ivVhM4VPvZQycQexample&quot;</span><span class="p">,</span>
        <span class="nt">&quot;createdAt&quot;</span><span class="p">:</span> <span class="s2">&quot;2016-08-19T19:42:41.961Z&quot;</span><span class="p">,</span>
        <span class="nt">&quot;modifiedAt&quot;</span><span class="p">:</span> <span class="s2">&quot;2016-08-19T19:42:41.961Z&quot;</span><span class="p">,</span>
        <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;givenName&quot;</span><span class="p">,</span>
        <span class="nt">&quot;required&quot;</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
        <span class="nt">&quot;schema&quot;</span><span class="p">:</span> <span class="p">{</span>
          <span class="nt">&quot;href&quot;</span><span class="p">:</span> <span class="s2">&quot;https://api.stormpath.com/v1/schemas/ivVhIkQVLGSLnLexample&quot;</span>
        <span class="p">}</span>
      <span class="p">},</span>
      <span class="p">{</span>
        <span class="nt">&quot;href&quot;</span><span class="p">:</span> <span class="s2">&quot;https://api.stormpath.com/v1/fields/ivVhPOaKVsPbRWrExample&quot;</span><span class="p">,</span>
        <span class="nt">&quot;createdAt&quot;</span><span class="p">:</span> <span class="s2">&quot;2016-08-19T19:42:41.961Z&quot;</span><span class="p">,</span>
        <span class="nt">&quot;modifiedAt&quot;</span><span class="p">:</span> <span class="s2">&quot;2016-08-19T20:03:25.497Z&quot;</span><span class="p">,</span>
        <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;surname&quot;</span><span class="p">,</span>
        <span class="nt">&quot;required&quot;</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
        <span class="nt">&quot;schema&quot;</span><span class="p">:</span> <span class="p">{</span>
          <span class="nt">&quot;href&quot;</span><span class="p">:</span> <span class="s2">&quot;https://api.stormpath.com/v1/schemas/ivVhIkQVLGSLnLexample&quot;</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">]</span>
  <span class="p">},</span>
  <span class="nt">&quot;directory&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&quot;href&quot;</span><span class="p">:</span> <span class="s2">&quot;https://api.stormpath.com/v1/directories/iusmp6mK91ZZ5example&quot;</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The two Account attributes (or <code class="docutils literal"><span class="pre">fields</span></code>) that can be toggled here are <code class="docutils literal"><span class="pre">givenName</span></code> and <code class="docutils literal"><span class="pre">surname</span></code>. By default both of these have <code class="docutils literal"><span class="pre">required</span></code> set to <code class="docutils literal"><span class="pre">false</span></code> for any Directories created after August 13, 2016.</p>
<p>This means that (providing your Directory was created after <code class="docutils literal"><span class="pre">2016-08-13</span></code>) you can create a new Account by passing only two attributes, <code class="docutils literal"><span class="pre">email</span></code> and <code class="docutils literal"><span class="pre">password</span></code>:</p>
<div class="highlight-http"><div class="highlight"><pre><span></span><span class="nf">POST</span> <span class="nn">/v1/directories/iusmp6mK91ZZ5example/accounts</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">api.stormpath.com</span>
<span class="na">Authorization</span><span class="o">:</span> <span class="l">Basic Mlp...</span>

{
  &quot;email&quot;:&quot;test123@email.com&quot;,
  &quot;password&quot;:&quot;APassword1234&quot;
}
</pre></div>
</div>
</div>
<div class="section" id="modifying-your-directory-s-account-schema">
<h3>3.5.2. Modifying your Directory&#8217;s Account Schema<a class="headerlink" href="#modifying-your-directory-s-account-schema" title="Permalink to this headline">¶</a></h3>
<p>Any attributes that are in the <code class="docutils literal"><span class="pre">fields</span></code> collection can have <code class="docutils literal"><span class="pre">required</span></code> toggled to either <code class="docutils literal"><span class="pre">true</span></code> or <code class="docutils literal"><span class="pre">false</span></code>.</p>
<p>If you wanted to set <code class="docutils literal"><span class="pre">surname</span></code> as required, you would send the following <code class="docutils literal"><span class="pre">POST</span></code>:</p>
<div class="highlight-http"><div class="highlight"><pre><span></span><span class="nf">POST</span> <span class="nn">/v1/fields/ivVhPOaKVsPbRWrExample</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">api.stormpath.com</span>
<span class="na">Authorization</span><span class="o">:</span> <span class="l">Basic Mlp...</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Cache-Control</span><span class="o">:</span> <span class="l">no-cache</span>

<span class="p">{</span>
  <span class="nt">&quot;required&quot;</span><span class="p">:</span><span class="s2">&quot;true&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>And get back the following <code class="docutils literal"><span class="pre">200</span> <span class="pre">OK</span></code>:</p>
<div class="highlight-json"><div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="nt">&quot;href&quot;</span><span class="p">:</span> <span class="s2">&quot;https://api.stormpath.com/v1/fields/ivVhPOaKVsPbRWrExample&quot;</span><span class="p">,</span>
  <span class="nt">&quot;createdAt&quot;</span><span class="p">:</span> <span class="s2">&quot;2016-08-19T19:42:41.961Z&quot;</span><span class="p">,</span>
  <span class="nt">&quot;modifiedAt&quot;</span><span class="p">:</span> <span class="s2">&quot;2016-08-19T20:03:25.497Z&quot;</span><span class="p">,</span>
  <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;surname&quot;</span><span class="p">,</span>
  <span class="nt">&quot;required&quot;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
  <span class="nt">&quot;schema&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&quot;href&quot;</span><span class="p">:</span> <span class="s2">&quot;https://api.stormpath.com/v1/schemas/ivVhIkQVLGSLnLexample&quot;</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>If you now tried to create another Account by passing only an <code class="docutils literal"><span class="pre">email</span></code> and <code class="docutils literal"><span class="pre">password</span></code>, you would get back a <code class="docutils literal"><span class="pre">400</span> <span class="pre">Bad</span> <span class="pre">Request</span></code> with <a class="reference external" href="https://docs.stormpath.com/rest/product-guide/latest/errors.html#error-2000">Error 2000</a>:</p>
<div class="highlight-json"><div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="nt">&quot;status&quot;</span><span class="p">:</span> <span class="mi">400</span><span class="p">,</span>
  <span class="nt">&quot;code&quot;</span><span class="p">:</span> <span class="mi">2000</span><span class="p">,</span>
  <span class="nt">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Account surname is required; it cannot be null, empty, or blank.&quot;</span><span class="p">,</span>
  <span class="nt">&quot;developerMessage&quot;</span><span class="p">:</span> <span class="s2">&quot;Account surname is required; it cannot be null, empty, or blank.&quot;</span><span class="p">,</span>
  <span class="nt">&quot;moreInfo&quot;</span><span class="p">:</span> <span class="s2">&quot;https://docs.stormpath.com/rest/product-guide/latest/errors.html#error-2000&quot;</span><span class="p">,</span>
  <span class="nt">&quot;requestId&quot;</span><span class="p">:</span> <span class="s2">&quot;49bd7a31-6650-11e6-9e22-22000befd8bd&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="how-to-verify-an-account-s-email">
<span id="verify-account-email"></span><h2>3.6. How to Verify an Account&#8217;s Email<a class="headerlink" href="#how-to-verify-an-account-s-email" title="Permalink to this headline">¶</a></h2>
<p>If you want to verify that an Account’s email address is valid and that the Account belongs to a real person, Stormpath can help automate this for you using <a class="reference external" href="http://docs.stormpath.com/console/product-guide/latest/directories.html#set-up-workflows">Workflows</a>.</p>
<div class="section" id="the-email-verification-workflow">
<h3>3.6.1. The Email Verification Workflow<a class="headerlink" href="#the-email-verification-workflow" title="Permalink to this headline">¶</a></h3>
<p>This workflow involves 3 parties: your application&#8217;s end-user, your application, and the Stormpath API server.</p>
<ol class="arabic simple">
<li>When the Account is created in a Directory that has “Verification” enabled, Stormpath will automatically send an email to the Account&#8217;s email address.</li>
<li>The end-user opens their email and clicks the verification link. This link comes with a token.</li>
<li>With the token, your application calls back to the Stormpath API server to complete the process.</li>
</ol>
<p>If you create a new Account in a Directory with both Account Registration and Verification enabled, Stormpath will automatically send a welcome email that contains a verification link to the Account’s email address on your behalf. If the person reading the email clicks the verification link in the email, the Account will then have an <code class="docutils literal"><span class="pre">ENABLED</span></code> status and be allowed to log in to applications. Additionally, the Account&#8217;s <code class="docutils literal"><span class="pre">emailVerificationStatus</span></code> will change to <code class="docutils literal"><span class="pre">VERIFIED</span></code>.</p>
<p>Accounts created in a Cloud Directory that has the Verification workflow enabled will have their <code class="docutils literal"><span class="pre">status</span></code> and <code class="docutils literal"><span class="pre">emailVerificationStatus</span></code> set to <code class="docutils literal"><span class="pre">UNVERIFIED</span></code> by default. When the email link is clicked, the Account&#8217;s <code class="docutils literal"><span class="pre">status</span></code> will change to <code class="docutils literal"><span class="pre">ENABLED</span></code> and its <code class="docutils literal"><span class="pre">emailVerificationStatus</span></code> will change to <code class="docutils literal"><span class="pre">VERIFIED</span></code>.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Accounts in Mirror Directories (SAML, Facebook, etc) have their <code class="docutils literal"><span class="pre">emailVerificationStatus</span></code> set to <code class="docutils literal"><span class="pre">VERIFIED</span></code> by default.</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>Accounts that have their <code class="docutils literal"><span class="pre">status</span></code> as <code class="docutils literal"><span class="pre">ENABLED</span></code> or <code class="docutils literal"><span class="pre">DISABLED</span></code> that were created before the <code class="docutils literal"><span class="pre">emailVerificationStatus</span></code> attribute was added to the Account resource will have their <code class="docutils literal"><span class="pre">emailVerificationStatus</span></code> set to <code class="docutils literal"><span class="pre">UNKNOWN</span></code>. Accounts with a <code class="docutils literal"><span class="pre">status</span></code> of <code class="docutils literal"><span class="pre">UNVERIFIED</span></code> will also have an <code class="docutils literal"><span class="pre">emailVerificationStatus</span></code> of <code class="docutils literal"><span class="pre">UNVERIFIED</span></code>.</p>
<p class="last">Accounts can also have their <code class="docutils literal"><span class="pre">emailVerificationStatus</span></code> manually set to <code class="docutils literal"><span class="pre">VERIFIED</span></code> or <code class="docutils literal"><span class="pre">UNVERIFIED</span></code> by updating the Account resource.</p>
</div>
<div class="section" id="the-account-verification-base-url">
<h4>The Account Verification Base URL<a class="headerlink" href="#the-account-verification-base-url" title="Permalink to this headline">¶</a></h4>
<p>It is also expected that the workflow’s <strong>Account Verification Base URL</strong> has been set to a URL that will be processed by your own application web server. This URL should be free of any query parameters, as the Stormpath back-end will append on to the URL a parameter used to verify the email. If this URL is not set, a default Stormpath-branded page will appear which allows the user to complete the workflow.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The Account Verification Base URL defaults to a Stormpath API Sever URL which, while it is functional, is a Stormpath API server web page. Because it will likely confuse your application end-users if they see a Stormpath web page, we strongly recommended that you specify a URL that points to your web application.</p>
</div>
</div>
</div>
<div class="section" id="configuring-the-verification-workflow">
<h3>3.6.2. Configuring the Verification Workflow<a class="headerlink" href="#configuring-the-verification-workflow" title="Permalink to this headline">¶</a></h3>
<p>This workflow is disabled by default on Directories, but you can enable it, and set up the account verification base URL, easily in the Stormpath Admin Console UI. Refer to the <a class="reference external" href="http://docs.stormpath.com/console/product-guide/latest/directories.html#set-up-workflows">Stormpath Admin Console Guide</a> for complete instructions.</p>
</div>
<div class="section" id="triggering-the-verification-email-creating-a-token">
<h3>3.6.3. Triggering the Verification Email (Creating A Token)<a class="headerlink" href="#triggering-the-verification-email-creating-a-token" title="Permalink to this headline">¶</a></h3>
<p>In order to verify an Account’s email address, an <code class="docutils literal"><span class="pre">emailVerificationToken</span></code> must be created for that Account. To create this token, you create an Account in a Directory, either programmatically or via a public account creation form of your own design, that has the account registration and verification workflows enabled.</p>
</div>
<div class="section" id="verifying-the-email-address-consuming-the-token">
<h3>3.6.4. Verifying the Email Address (Consuming The Token)<a class="headerlink" href="#verifying-the-email-address-consuming-the-token" title="Permalink to this headline">¶</a></h3>
<p>The email that is sent upon Account creation contains a link to the base URL that you&#8217;ve configured, along with the <code class="docutils literal"><span class="pre">sptoken</span></code> query string parameter. By default, it looks like this:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>https://api.stormpath.com/emailVerificationTokens?sptoken=$VERIFICATION_TOKEN
</pre></div>
</div>
<p>If you were to click this URL now, it would simply open up a page telling us that the Account had been verified. However, we can use this URL in order to verify the Account and also retrieve the Account information.</p>
<p>You can use the <code class="docutils literal"><span class="pre">verify_email_token()</span></code> method on the Client&#8217;s <code class="docutils literal"><span class="pre">accounts</span></code> collection, plus the token you capture from the query string, to verify the Account:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">account</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">accounts</span><span class="o">.</span><span class="n">verify_email_token</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">For more about Account Authentication you can read <a class="reference internal" href="auth_n.html#authn"><span class="std std-ref">the next chapter</span></a>.</p>
</div>
</div>
<div class="section" id="resending-the-verification-email">
<span id="resending-verification-email"></span><h3>3.6.5. Resending the Verification Email<a class="headerlink" href="#resending-the-verification-email" title="Permalink to this headline">¶</a></h3>
<p>If a user accidentally deletes their verification email, or it was undeliverable for some reason, it is possible to resend the email.</p>
<p>To resend the email, use the <code class="docutils literal"><span class="pre">send_verification_email()</span></code> method:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">application</span><span class="o">.</span><span class="n">verification_emails</span><span class="o">.</span><span class="n">resend</span><span class="p">(</span><span class="n">account</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="customizing-stormpath-emails">
<h2>3.7. Customizing Stormpath Emails<a class="headerlink" href="#customizing-stormpath-emails" title="Permalink to this headline">¶</a></h2>
<div class="section" id="what-emails-does-stormpath-send">
<h3>3.7.1. What Emails Does Stormpath Send?<a class="headerlink" href="#what-emails-does-stormpath-send" title="Permalink to this headline">¶</a></h3>
<p>Stormpath can be configured to send emails to users as part of a Directory&#8217;s Account Creation and Password Reset policies.</p>
<div class="section" id="id7">
<h4>Account Creation<a class="headerlink" href="#id7" title="Permalink to this headline">¶</a></h4>
<p>Found in: <a class="reference external" href="https://docs.stormpath.com/rest/product-guide/latest/reference.html#account-creation-policy">Account Creation Policy</a></p>
<ul class="simple">
<li><em>Verification Email</em>: The initial email that is sent out after Account creation that verifies the email address that was used for registration with a link containing the verification token.</li>
<li><em>Verification Success Email</em>: An email that is sent after a successful email verification.</li>
<li><em>Welcome Email</em>: An email welcoming the user to your application.</li>
</ul>
<p>For more information about this, see <a class="reference internal" href="#verify-account-email"><span class="std std-ref">3.6. How to Verify an Account&#8217;s Email</span></a>.</p>
</div>
<div class="section" id="id8">
<h4>Password Reset<a class="headerlink" href="#id8" title="Permalink to this headline">¶</a></h4>
<p>Found in: <a class="reference external" href="https://docs.stormpath.com/rest/product-guide/latest/reference.html#password-policy">Password Policy</a></p>
<ul class="simple">
<li><em>Reset Email</em>: The email that is sent out after a user asks to reset their password. It contains a URL with a password reset token.</li>
<li><em>Reset Success Email</em>:  An email that is sent after a successful password reset.</li>
</ul>
<p>For more information about this, see <a class="reference internal" href="#password-reset-flow"><span class="std std-ref">3.4.3. Password Reset</span></a>.</p>
</div>
</div>
<div class="section" id="customizing-stormpath-email-templates">
<span id="customizing-email-templates"></span><h3>3.7.2. Customizing Stormpath Email Templates<a class="headerlink" href="#customizing-stormpath-email-templates" title="Permalink to this headline">¶</a></h3>
<p>The emails that Stormpath sends to users be customized by modifying the <a class="reference external" href="https://docs.stormpath.com/rest/product-guide/latest/reference.html#email-templates">Email Templates</a> resource. This can be done either via the &#8220;Directory Workflows&#8221; section of the <a class="reference external" href="https://api.stormpath.com/login">Stormpath Admin Console</a>, or as explained below.</p>
<p><strong>Verification</strong>, <strong>Verification Success</strong>, and <strong>Welcome</strong> Email Templates can all be found under the Directory’s <strong>Account Creation Policies</strong>:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">policy</span> <span class="o">=</span> <span class="n">directory</span><span class="o">.</span><span class="n">account_creation_policy</span>

<span class="n">verification</span> <span class="o">=</span> <span class="n">policy</span><span class="o">.</span><span class="n">verification_email_templates</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">verification_success</span> <span class="o">=</span> <span class="n">policy</span><span class="o">.</span><span class="n">verification_success_email_templates</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">welcome</span> <span class="o">=</span> <span class="n">policy</span><span class="o">.</span><span class="n">welcome_email_templates</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
<p><strong>Password Reset</strong>, and <strong>Reset Success</strong> Email Templates can be found under the Directory’s <strong>Password Policies</strong>:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">policy</span> <span class="o">=</span> <span class="n">directory</span><span class="o">.</span><span class="n">password_policy</span>

<span class="n">password_reset</span> <span class="o">=</span> <span class="n">policy</span><span class="o">.</span><span class="n">reset_email_templates</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">reset_success</span> <span class="o">=</span> <span class="n">policy</span><span class="o">.</span><span class="n">reset_success_email_templates</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
<p>To modify any of these emails via the Python SDK, it is just a matter of updating the appropriate Template resource.</p>
<p>As an example, let’s look at a default Verification Email template that comes with the Stormpath Administrator Directory’s Account Creation Policies:</p>
<div class="highlight-json"><div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="nt">&quot;href&quot;</span><span class="p">:</span><span class="s2">&quot;https://api.stormpath.com/v1/emailTemplates/2jwPxFsnjqxYrojexample&quot;</span><span class="p">,</span>
  <span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="s2">&quot;Default Verification Email Template&quot;</span><span class="p">,</span>
  <span class="nt">&quot;description&quot;</span><span class="p">:</span><span class="s2">&quot;This is the verification email template that is associated with the directory.&quot;</span><span class="p">,</span>
  <span class="nt">&quot;fromName&quot;</span><span class="p">:</span><span class="s2">&quot;Jakub Swiatczak&quot;</span><span class="p">,</span>
  <span class="nt">&quot;fromEmailAddress&quot;</span><span class="p">:</span><span class="s2">&quot;change-me@stormpath.com&quot;</span><span class="p">,</span>
  <span class="nt">&quot;subject&quot;</span><span class="p">:</span><span class="s2">&quot;Verify your account&quot;</span><span class="p">,</span>
  <span class="nt">&quot;textBody&quot;</span><span class="p">:</span><span class="s2">&quot;Hi,\nYou have been registered for an application that uses Stormpath.\n\n$!{url}\n\nOnce you verify, you will be able to login.\n\n---------------------\nFor general inquiries or to request support with your account, please email change-me@stormpath.com&quot;</span><span class="p">,</span>
  <span class="nt">&quot;htmlBody&quot;</span><span class="p">:</span><span class="s2">&quot;&lt;p&gt;Hi,&lt;/p&gt;\n&lt;p&gt;You have been registered for an application that uses Stormpath.&lt;/p&gt;&lt;a href=\&quot;$!{url}\&quot;&gt;Click here to verify your account&lt;/a&gt;&lt;p&gt;Once you verify, you will be able to login.&lt;/p&gt;&lt;p&gt;--------------------- &lt;br /&gt;For general inquiries or to request support with your account, please email change-me@stormpath.com&lt;/p&gt;&quot;</span><span class="p">,</span>
  <span class="nt">&quot;mimeType&quot;</span><span class="p">:</span><span class="s2">&quot;text/plain&quot;</span><span class="p">,</span>
  <span class="nt">&quot;defaultModel&quot;</span><span class="p">:{</span>
    <span class="nt">&quot;linkBaseUrl&quot;</span><span class="p">:</span><span class="s2">&quot;https://api.stormpath.com/emailVerificationTokens&quot;</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>If you wanted to change the <code class="docutils literal"><span class="pre">fromEmailAddress</span></code> attribute, you would just update this attribute:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">verification</span><span class="o">.</span><span class="n">from_email_address</span> <span class="o">=</span> <span class="s1">&#39;jakub@stormpath.com&#39;</span>
<span class="n">verification</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
</pre></div>
</div>
<p>For more information about Stormpath&#8217;s email templates, keep reading!</p>
<p><strong>Message Format</strong></p>
<p>The <code class="docutils literal"><span class="pre">mimeType</span></code> designates whether the email is sent as plain text (<code class="docutils literal"><span class="pre">text/plain</span></code>), HTML (<code class="docutils literal"><span class="pre">text/html</span></code>), or both (<code class="docutils literal"><span class="pre">multipart/alternative</span></code>). This in turns tells Stormpath whether to use the <code class="docutils literal"><span class="pre">textBody</span></code> or <code class="docutils literal"><span class="pre">htmlBody</span></code> text in the email, or to let the email client decide.</p>
<p><strong>textBody and htmlBody</strong></p>
<p>These define the actual content of the email. The only difference is that <code class="docutils literal"><span class="pre">htmlBody</span></code> is allowed to contain HTML markup while <code class="docutils literal"><span class="pre">textBody</span></code> only accepts plaintext. Both are also able to use <a class="reference external" href="http://web.cerritos.edu/jwilson/SitePages/java_language_resources/Java_Escape_Sequences.htm">Java Escape Sequences</a>. Both <code class="docutils literal"><span class="pre">htmlBody</span></code> and <code class="docutils literal"><span class="pre">textBody</span></code> can have customized output generated using template macros. For more on those, see the very next section.</p>
<div class="section" id="using-email-macros">
<span id="id10"></span><h4>Using Email Macros<a class="headerlink" href="#using-email-macros" title="Permalink to this headline">¶</a></h4>
<p>Macros are placeholder text that are converted into actual values at the time the email is generated. You could use a macro to insert your user&#8217;s first name into the email, as well as the name of your Application. This would look like this:</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="s">&quot;Hi $!{account.givenName}, welcome to $!{application.name}!&quot;</span>
</pre></div>
</div>
<p>The basic structure for a macro is <code class="docutils literal"><span class="pre">$!{resource.attribute}</span></code>. There are three kinds of <code class="docutils literal"><span class="pre">resource</span></code> that you can work with:</p>
<ul class="simple">
<li>Account (<code class="docutils literal"><span class="pre">$!{account}</span></code>)</li>
<li>an Account&#8217;s Directory (<code class="docutils literal"><span class="pre">$!{account.directory}</span></code>), and</li>
<li>an Application (<code class="docutils literal"><span class="pre">$!{application}</span></code>).</li>
</ul>
<p>You can also include any <code class="docutils literal"><span class="pre">attribute</span></code> that isn&#8217;t a link, as well as customData.</p>
<p>For a full list of email macros, see the <a class="reference external" href="https://docs.stormpath.com/rest/product-guide/latest/reference.html#email-templates">Email Macros</a> section of the Reference chapter.</p>
<div class="section" id="macros-and-customdata">
<h5>Macros and customData<a class="headerlink" href="#macros-and-customdata" title="Permalink to this headline">¶</a></h5>
<p>The formatting for customData macros is as follows:</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="n">$</span><span class="o">!{</span><span class="n">resource</span><span class="o">.</span><span class="na">attribute</span><span class="o">.</span><span class="na">customData</span><span class="o">.</span><span class="na">key</span><span class="o">}</span>
</pre></div>
</div>
<p>You may have noticed here and with the Application resource that there is an included <code class="docutils literal"><span class="pre">!</span></code> character, this is called a &#8220;quiet reference&#8221;.</p>
</div>
<div class="section" id="quiet-references">
<span id="quiet-macro-reference"></span><h5>Quiet References<a class="headerlink" href="#quiet-references" title="Permalink to this headline">¶</a></h5>
<p>Quiet references (<code class="docutils literal"><span class="pre">!</span></code>) tell Stormpath that, if it can&#8217;t resolve the object, it should just show nothing. Normally, if a macro was  <code class="docutils literal"><span class="pre">Is</span> <span class="pre">your</span> <span class="pre">favorite</span> <span class="pre">color</span> <span class="pre">$!{account.customData.favoriteColor}?</span></code>, and Stormpath was able to find the value as <code class="docutils literal"><span class="pre">blue</span></code>, it would output:</p>
<p><code class="docutils literal"><span class="pre">Is</span> <span class="pre">your</span> <span class="pre">favorite</span> <span class="pre">color</span> <span class="pre">blue?</span></code></p>
<p>However, if the value could not be found, it would output:</p>
<p><code class="docutils literal"><span class="pre">Is</span> <span class="pre">your</span> <span class="pre">favorite</span> <span class="pre">color</span> <span class="pre">$!{account.customData.favoriteColor}?</span></code></p>
<p>To avoid this, you include the <code class="docutils literal"><span class="pre">!</span></code> which puts the macro into &#8220;quiet reference&#8221; mode. This means that if the value is not found, the output will be:</p>
<p><code class="docutils literal"><span class="pre">Is</span> <span class="pre">your</span> <span class="pre">favorite</span> <span class="pre">color</span> <span class="pre">?</span></code></p>
<p>Since customData can contain any arbitrary key-value pairs, Stormpath recommends that any email macro references to customData keys use the <code class="docutils literal"><span class="pre">!</span></code> quiet reference. Applications should also use the quiet reference because there are possible cases where the templating engine might not have access to an Application resource.</p>
</div>
</div>
</div>
<div class="section" id="customizing-your-smtp-server">
<span id="add-custom-smtp"></span><h3>3.7.3. Customizing Your SMTP Server<a class="headerlink" href="#customizing-your-smtp-server" title="Permalink to this headline">¶</a></h3>
<p>Normally, the emails that Stormpath sends as a part of processes like Account creation and password reset come from Stormpath&#8217;s SMTP server. However, it is possible to configure Stormpath to send emails using an SMTP server of your choosing.</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">This feature is not yet available in the Python SDK. In the meantime, please consult the REST API documentation below.</p>
</div>
<p>Your Tenant is allowed to specify one server, and that server&#8217;s information is stored in an SMTP server resource accessible either directly:</p>
<p><code class="docutils literal"><span class="pre">v1/smtpServers/$SMTP_SERVER_ID</span></code></p>
<p>Or off of your Tenant:</p>
<p><code class="docutils literal"><span class="pre">v1/tenants/$TENANT_ID/smtpServers</span></code></p>
<p>In the event that sending an email using the custom SMTP server fails repeatedly, Stormpath will fall back to its own server. In this situation, Stormpath will also send you an email alerting you to the error.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">If Stormpath uses its own SMTP server to send email, this may cause a conflict with your <a class="reference external" href="http://www.openspf.org/Introduction">SPF records</a> which might result in those emails being marked as spam by email clients.</p>
</div>
<div class="section" id="adding-a-new-custom-server">
<h4>Adding a new Custom Server<a class="headerlink" href="#adding-a-new-custom-server" title="Permalink to this headline">¶</a></h4>
<p>In addition to the location and port of the server, you must also pass valid credentials. Before creating the resource, Stormpath will confirm that the information given is valid and that a connection can be established. If the <code class="docutils literal"><span class="pre">host</span></code>, <code class="docutils literal"><span class="pre">port</span></code>, <code class="docutils literal"><span class="pre">username</span></code> or <code class="docutils literal"><span class="pre">password</span></code> are incorrect, you will receive back <a class="reference internal" href="errors.html#errors-130xx"><span class="std std-ref">an error</span></a>. If a custom server already exists for your Stormpath Tenant, then you will also receive <a class="reference internal" href="errors.html#errors-130xx"><span class="std std-ref">an error</span></a>.</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">This feature is not yet available in the Python SDK. In the meantime, please consult the REST API documentation below.</p>
</div>
<p>For the full description of what is inside an SMTP Server resource, please see <a class="reference external" href="https://docs.stormpath.com/rest/product-guide/latest/reference.html#ref-custom-smtp">the Reference chapter</a>. A successful custom server POST would look like this:</p>
<div class="highlight-http"><div class="highlight"><pre><span></span><span class="nf">POST</span> <span class="nn">/v1/smtpServers</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">api.stormpath.com</span>
<span class="na">Authorization</span><span class="o">:</span> <span class="l">Basic MlpG...</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json</span>

<span class="p">{</span>
  <span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="s2">&quot;My SMTP Server&quot;</span><span class="p">,</span>
  <span class="nt">&quot;description&quot;</span><span class="p">:</span><span class="s2">&quot;My Awesome SMTP Server&quot;</span><span class="p">,</span>
  <span class="nt">&quot;username&quot;</span><span class="p">:</span><span class="s2">&quot;ausername&quot;</span><span class="p">,</span>
  <span class="nt">&quot;password&quot;</span><span class="p">:</span><span class="s2">&quot;Apassw0rd&quot;</span><span class="p">,</span>
  <span class="nt">&quot;securityProtocol&quot;</span><span class="p">:</span><span class="s2">&quot;tls&quot;</span><span class="p">,</span>
  <span class="nt">&quot;host&quot;</span><span class="p">:</span><span class="s2">&quot;email.host.com&quot;</span><span class="p">,</span>
  <span class="nt">&quot;port&quot;</span><span class="p">:</span><span class="mi">25</span>
<span class="p">}</span>
</pre></div>
</div>
<p>With the following response:</p>
<div class="highlight-http"><div class="highlight"><pre><span></span><span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">201</span> <span class="ne">Created</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json;charset=UTF-8</span>

<span class="p">{</span>
    <span class="nt">&quot;createdAt&quot;</span><span class="p">:</span> <span class="s2">&quot;2016-06-23T22:04:47.163Z&quot;</span><span class="p">,</span>
    <span class="nt">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;My Awesome SMTP Server&quot;</span><span class="p">,</span>
    <span class="nt">&quot;host&quot;</span><span class="p">:</span> <span class="s2">&quot;email.host.com&quot;</span><span class="p">,</span>
    <span class="nt">&quot;href&quot;</span><span class="p">:</span> <span class="s2">&quot;https://api.stormpath.com/v1/smtpServers/3svYfnFPh3q2Hbfexample&quot;</span><span class="p">,</span>
    <span class="nt">&quot;modifiedAt&quot;</span><span class="p">:</span> <span class="s2">&quot;2016-06-23T22:04:47.163Z&quot;</span><span class="p">,</span>
    <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;My SMTP Server&quot;</span><span class="p">,</span>
    <span class="nt">&quot;port&quot;</span><span class="p">:</span> <span class="mi">25</span><span class="p">,</span>
    <span class="nt">&quot;securityProtocol&quot;</span><span class="p">:</span> <span class="s2">&quot;TLS&quot;</span><span class="p">,</span>
    <span class="nt">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;ENABLED&quot;</span><span class="p">,</span>
    <span class="nt">&quot;tenant&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&quot;href&quot;</span><span class="p">:</span> <span class="s2">&quot;api.stormpath.com/v1/tenants/1gBTncWsp2ObQGgexample&quot;</span>
    <span class="p">},</span>
    <span class="nt">&quot;username&quot;</span><span class="p">:</span> <span class="s2">&quot;ausername&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="deleting-a-custom-server">
<h4>Deleting a Custom Server<a class="headerlink" href="#deleting-a-custom-server" title="Permalink to this headline">¶</a></h4>
<p>If you would like to stop using the custom server, you can disable it by setting its <code class="docutils literal"><span class="pre">status</span></code> to <code class="docutils literal"><span class="pre">DISABLED</span></code>. A more permanent solution is to delete the SMTP Server resource entirely. This is also required if you would like to use a different server, since your Tenant can only have one of these resources at any given time.</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">This feature is not yet available in the Python SDK. In the meantime, please consult the REST API documentation below.</p>
</div>
<div class="highlight-http"><div class="highlight"><pre><span></span><span class="nf">DELETE</span> <span class="nn">/v1/smtpServers/3svYfnFPh3q2Hbfexample</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
</pre></div>
</div>
<p>Upon successful deletion you will get back a <code class="docutils literal"><span class="pre">204</span> <span class="pre">No</span> <span class="pre">Content</span></code> message.</p>
</div>
</div>
<div class="section" id="restricting-user-email-domains">
<span id="email-domain-restriction"></span><h3>3.7.4 Restricting User Email Domains<a class="headerlink" href="#restricting-user-email-domains" title="Permalink to this headline">¶</a></h3>
<p>As a developer, you are able to restrict which emails can be used by Accounts within a particular Directory. You control this by adding domains to either a Domain Whitelist or Blacklist, both of which are attached to your Directory&#8217;s Account Creation Policies. This means that if an email is used as part of user registration, or a user later tries to update their Account with a new email, that email will be checked against that Whitelist and/or Blacklist.</p>
<p>If your Whitelist contains only <code class="docutils literal"><span class="pre">stormpath.com</span></code> then only email addresses from that domain will be allowed for your user Accounts. If a user tries to register a new Account without using a Stormpath address, then the Account creation will error. If they try to update their Account with a new address that isn&#8217;t a Stormpath address, the update will also fail.</p>
<div class="section" id="domain-entries">
<h4>Domain Entries<a class="headerlink" href="#domain-entries" title="Permalink to this headline">¶</a></h4>
<p>Examples of domain entries include:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">*site.com</span></code></li>
<li><code class="docutils literal"><span class="pre">*.site.com</span></code></li>
<li><code class="docutils literal"><span class="pre">site.*.com</span></code></li>
<li><code class="docutils literal"><span class="pre">site.*</span></code></li>
<li><code class="docutils literal"><span class="pre">*.com</span></code></li>
</ul>
<p>You can enter in a <code class="docutils literal"><span class="pre">*</span></code> wildcard at any point in the email domain, and this will either allow or disallow (depending on which list you add it to) all emails fitting that pattern.</p>
<p>For example, the entry <code class="docutils literal"><span class="pre">*site.com</span></code> would match:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">site</span><span class="o">.</span><span class="n">com</span>
<span class="n">zsite</span><span class="o">.</span><span class="n">com</span>
<span class="nb">id</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">com</span>
</pre></div>
</div>
<p>The slightly different entry <code class="docutils literal"><span class="pre">*.site.com</span></code> would match:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="nb">id</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">com</span>
</pre></div>
</div>
<p>But would not match:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">site</span><span class="o">.</span><span class="n">com</span>
<span class="n">zsite</span><span class="o">.</span><span class="n">com</span>
</pre></div>
</div>
</div>
<div class="section" id="working-with-the-lists">
<h4>Working with the Lists<a class="headerlink" href="#working-with-the-lists" title="Permalink to this headline">¶</a></h4>
<p>Working with the Whitelist and Blacklist is done through the Account Creation Policy of a Directory.</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">This feature is not yet available in the Python SDK. In the meantime, please consult the REST API documentation below.</p>
</div>
<p>In both cases, you send an array in this format:</p>
<div class="highlight-json"><div class="highlight"><pre><span></span><span class="p">[</span>
  <span class="s2">&quot;*domain.com&quot;</span><span class="p">,</span>
  <span class="s2">&quot;*.another.ca&quot;</span>
<span class="p">]</span>
</pre></div>
</div>
<p>Keep in mind the following when you work with the Whitelist and Blacklist:</p>
<ul class="simple">
<li>If you would like to specify domains that are to be allowed, you add entries to the <code class="docutils literal"><span class="pre">emailDomainWhitelist</span></code> array.</li>
<li>For domains that are to be disallowed, you add entries to the <code class="docutils literal"><span class="pre">emailDomainBlacklist</span></code> array.</li>
<li>Both arrays are empty by default.</li>
<li>An empty <code class="docutils literal"><span class="pre">emailDomainWhitelist</span></code> means that all email domains are allowed.</li>
<li>An empty <code class="docutils literal"><span class="pre">emailDomainBlacklist</span></code> means that no email domains are disallowed.</li>
<li>To add or remove entries, you must overwrite the entire list. See examples below.</li>
<li>The Blacklist takes precedence over the Whitelist. That means that if <code class="docutils literal"><span class="pre">site.com</span></code> is found in both lists, the Blacklist will take priority, and users will not be able to use any emails from the <code class="docutils literal"><span class="pre">site.com</span></code> domain.</li>
</ul>
<div class="section" id="adding-a-domain">
<h5>Adding a Domain<a class="headerlink" href="#adding-a-domain" title="Permalink to this headline">¶</a></h5>
<p>If you wanted to allow only users using emails from <code class="docutils literal"><span class="pre">site.com</span></code> and <code class="docutils literal"><span class="pre">stormpath.com</span></code> to register for this Directory, you could add the following entries to the Whitelist:</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">This feature is not yet available in the Python SDK. In the meantime, please consult the REST API documentation below.</p>
</div>
<div class="highlight-http"><div class="highlight"><pre><span></span><span class="nf">POST</span> <span class="nn">/v1/accountCreationPolicies/2SKhstu8PlaekcaEXampLE</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">api.stormpath.com</span>
<span class="na">Authorization</span><span class="o">:</span> <span class="l">Basic MlpG...</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json</span>

<span class="p">{</span>
  <span class="nt">&quot;emailDomainWhitelist&quot;</span><span class="p">:</span> <span class="p">[</span>
    <span class="s2">&quot;*stormpath.com&quot;</span><span class="p">,</span>
    <span class="s2">&quot;*site.com&quot;</span>
  <span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Now, if an Account is passed to Stormpath with an email domain that does not match the entries on this Whitelist, you will get back <a class="reference external" href="https://docs.stormpath.com/rest/product-guide/latest/errors.html#error-7206">an error</a>.</p>
<p>If you were instead working with a Blacklist, and you had added <code class="docutils literal"><span class="pre">*stormpath.com</span></code> and <code class="docutils literal"><span class="pre">*site.com</span></code> to there, then if an Account were passed to Stormpath that contained an email from either of those domains, you would also get back <a class="reference external" href="https://docs.stormpath.com/rest/product-guide/latest/errors.html#error-7205">an error</a>.</p>
</div>
<div class="section" id="removing-a-domain">
<h5>Removing a Domain<a class="headerlink" href="#removing-a-domain" title="Permalink to this headline">¶</a></h5>
<p>If you changed our mind and wanted to only allow users to register with <code class="docutils literal"><span class="pre">stormpath.com</span></code> emails, then you would just update and overwrite the existing Whitelist:</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">This feature is not yet available in the Python SDK. In the meantime, please consult the REST API documentation below.</p>
</div>
<p>And then you&#8217;d get back the Account Policies, with the updated Whitelist:</p>
<div class="highlight-json"><div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="nt">&quot;href&quot;</span><span class="p">:</span> <span class="s2">&quot;https://staging-api-b.stormpath.com/v1/accountCreationPolicies/2SKhstu8PlaekcaEXampLE&quot;</span><span class="p">,</span>
  <span class="nt">&quot;verificationEmailStatus&quot;</span><span class="p">:</span> <span class="s2">&quot;DISABLED&quot;</span><span class="p">,</span>
  <span class="nt">&quot;verificationSuccessEmailStatus&quot;</span><span class="p">:</span> <span class="s2">&quot;DISABLED&quot;</span><span class="p">,</span>
  <span class="nt">&quot;welcomeEmailStatus&quot;</span><span class="p">:</span> <span class="s2">&quot;DISABLED&quot;</span><span class="p">,</span>
  <span class="nt">&quot;emailDomainWhitelist&quot;</span><span class="p">:</span> <span class="p">[</span>
    <span class="s2">&quot;*stormpath.com&quot;</span>
  <span class="p">],</span>
  <span class="nt">&quot;emailDomainBlacklist&quot;</span><span class="p">:</span> <span class="p">[],</span>
  <span class="nt">&quot;...&quot;</span><span class="p">:</span><span class="s2">&quot;...&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Working with the Blacklist is exactly the same, except you add entries to the <code class="docutils literal"><span class="pre">emailDomainBlacklist</span></code> array instead.</p>
</div>
</div>
</div>
</div>
<div class="section" id="account-linking">
<span id="id11"></span><h2>3.8. Account Linking<a class="headerlink" href="#account-linking" title="Permalink to this headline">¶</a></h2>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">This feature is not yet available in the Python SDK. In the meantime you can find the REST documentation below.</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>Before you read this section, we recommend that you familiarize yourself with:</p>
<ul class="last simple">
<li><a class="reference internal" href="auth_n.html#how-login-works"><span class="std std-ref">How Login Works</span></a></li>
<li><a class="reference internal" href="auth_n.html#social-authn"><span class="std std-ref">How Social Authentication Works</span></a></li>
</ul>
</div>
<p>To quickly recap: Every source of user Accounts requires its own Directory in Stormpath. This means that users who directly register through your app will probably be stored inside a Cloud Directory, users who choose to login with Facebook will have to go into a Facebook Directory, and so on.</p>
<p>When a user chooses to log in with a non-Cloud Directory (e.g. Facebook, SAML, etc), Stormpath creates an Account resource to represent them in the appropriate Directory and then returns it upon successful login.</p>
<p>What happens if a user logs in directly with your application one day, then with Facebook the next day, and then with Google as well. The answer is that they will have 3 different Account resources, each one in a different Directory.</p>
<p>To unify these Accounts, Stormpath offers Account Linking. Account Linking allows you to ensure that the Account that is returned on authentication is always the same Account found in the <a class="reference internal" href="#add-to-app-or-org"><span class="std std-ref">default Account Store</span></a>.</p>
<p>So in the above example, the user could create three separate Accounts in three separate Directories, but if all of those Accounts were linked then each login attempt would always return the same Account resource, regardless of which login method they chose. Moreover, each Account would be associated with the Account in the default Directory via Account Links.</p>
<p id="account-linking-benefits"><strong>What if I only want to support Social/SAML/etc?</strong></p>
<p>Even if you wanted to only offer Social Login options, or only SAML-based login, we still recommend that you maintain a separate Cloud Directory. For example, if you wanted to only allow Login via Facebook, it still makes sense to have a Cloud Directory separate from your Facebook Directory.</p>
<ul class="simple">
<li>You can maintain one Directory that has all your user Accounts, retaining globally unique canonical identities across your application</li>
<li>You are able to leverage your own Groups in the master Directory. Remember, most data in a Mirror Directory is read-only, meaning you cannot create your own Groups in it, only read the Groups (if any) synchronized from the external directory.</li>
<li>Keep a user’s identity alive even after they’ve left your customer’s organization and been deprovisioned in the external user directory. This is valuable in a SaaS model where the user is loosely coupled to an organization. Contractors and temporary workers are good examples.</li>
<li>If you wanted to offer new kinds of login in the future, it would be as simple as creating a new kind of Mirror Directory and then ensuring that the new Accounts in that Directory are linked to the one that already exists in the default Directory.</li>
</ul>
<div class="section" id="how-login-works-with-linked-accounts">
<span id="account-linking-login"></span><h3>How Login Works with Linked Accounts<a class="headerlink" href="#how-login-works-with-linked-accounts" title="Permalink to this headline">¶</a></h3>
<p>There are a number of different scenarios which can occur during login.</p>
<div class="section" id="application-vs-organization-account-linking-policies">
<h4>Application vs Organization Account Linking Policies<a class="headerlink" href="#application-vs-organization-account-linking-policies" title="Permalink to this headline">¶</a></h4>
<p>First and foremost, both Applications and Organizations have Account Linking Policies. Stormpath will default to the Application&#8217;s Policy if you do not specify an Organization during login.</p>
<div class="highlight-http"><div class="highlight"><pre><span></span><span class="nf">POST</span> <span class="nn">/v1/applications/1gk4Dxzi6o4PbdleXaMPLE/loginAttempts</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">api.stormpath.com</span>
<span class="na">Authorization</span><span class="o">:</span> <span class="l">Basic MlpG...</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json</span>

<span class="p">{</span>
  <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;basic&quot;</span><span class="p">,</span>
  <span class="nt">&quot;value&quot;</span><span class="p">:</span> <span class="s2">&quot;YWxhbkBzbWl0aGVlZS5jb206UGFzcexample&quot;</span><span class="p">,</span>
  <span class="nt">&quot;accountStore&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&quot;nameKey&quot;</span><span class="p">:</span><span class="s2">&quot;tenantOneTwoThree&quot;</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>For an example of how this works, please see <a class="reference internal" href="#account-linking-automatic-ex2"><span class="std std-ref">below</span></a>.</p>
</div>
<div class="section" id="example-login-behaviors">
<h4>Example Login Behaviors<a class="headerlink" href="#example-login-behaviors" title="Permalink to this headline">¶</a></h4>
<p>For the sake of our examples below, we will assume that there are just two Accounts, one in a Cloud Directory, and one in a Facebook Directory. Further, the Cloud Directory is the default Account Store.</p>
<p><strong>With Account Linking Disabled</strong></p>
<p>If the Account Linking Policy is completely disabled then Stormpath ignores Account Links and does not perform any Account Linking behavior.</p>
<p>Example: A user logs in with Facebook, and Stormpath returns the Account in the Facebook Directory.</p>
<p><strong>With Account Linking Enabled, and Existing, Unlinked Accounts</strong></p>
<p>If the Account Linking Policy is at least enabled, then on login, Stormpath checks to see if the current Account used for login has any existing Account Links and follows those links. If no linked Accounts exist at all, Stormpath will return whatever Account was used to log in.</p>
<p>Example: A user logs in with Facebook, and Stormpath returns the Account in the Facebook Directory.</p>
<p><strong>With Existing, Linked Accounts</strong></p>
<p>On login, Stormpath checks to see if the current Account used for login has any existing Account Links and follows those links. If (1) the current Account is not in the default Account Store and (2) it finds a linked Account that is in the default Account Store, then Stormpath will return that linked Account.</p>
<p>Example: A user logs in with Facebook, and their existing Account in the Stormpath Facebook Directory is linked with an Account found in the Application&#8217;s default Cloud Directory. Stormpath returns the Account from the Cloud Directory, instead of the Account from the Facebook Directory.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">If the Accounts are already linked, then the status of Automatic Account Linking is irrelevant.</p>
</div>
<p><strong>With Automatic Account Linking</strong></p>
<p>Stormpath still checks the current Account&#8217;s links to see what other Accounts are linked to it. With Automatic Account Linking, however, Stormpath can also:</p>
<ul class="simple">
<li>Automatically link any Accounts that it finds that are not linked but should be.</li>
<li>Create a new Account in the default Account Store and link that Account to the one that was used to log in.</li>
</ul>
<p>Example: The user logs in with Facebook for the first time and an Account is created in the Facebook Directory. The Application has an Account Link Policy that has automatic provisioning enabled based on the Account&#8217;s email. Stormpath finds no Account in the default Cloud Directory with this email. An Account is created in the Cloud Directory and linked to the Account in the Facebook Directory. Stormpath returns the newly-created Account from the Cloud Directory, instead of the Account from the Facebook Directory.</p>
<p>The details of Automatic Account Linking are more fully explained <a class="reference internal" href="#account-linking-automatic"><span class="std std-ref">below</span></a>.</p>
<p><strong>Manual vs Automatic Account Linking</strong></p>
<p>All Account Links are separate resources that link together two Accounts found in separate Directories. The Account Linking process itself comes in two varieties: manual, and automatic.</p>
<p>Manual Account Linking involves you manually creating an Account Link resource, that links two Account resources. Automatic Account Linking creates these Account Links automatically based upon behavior configured inside an Account Link Policy resource. These Policy resources can be attached to either an Application or an Organization.</p>
</div>
</div>
<div class="section" id="how-to-link-accounts-manually">
<span id="account-linking-manual"></span><h3>How to Link Accounts Manually<a class="headerlink" href="#how-to-link-accounts-manually" title="Permalink to this headline">¶</a></h3>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">If you are not interested in manual account linking, you can skip ahead and read about <a class="reference internal" href="#account-linking-automatic"><span class="std std-ref">How to Link Accounts Automatically</span></a>.</p>
</div>
<p>Let&#8217;s say we have two Directories: a Cloud Directory, and a Facebook Directory. Both the The Cloud and Facebook Directories are mapped to the same Application, but the Cloud Directory is the default Account Store.</p>
<p>In each of those Directories, there is an Account. One in our Cloud Directory, for user Picard:</p>
<div class="highlight-json"><div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="nt">&quot;href&quot;</span><span class="p">:</span> <span class="s2">&quot;https://api.stormpath.com/v1/accounts/7hOYWCzhhKDFHFzExample&quot;</span><span class="p">,</span>
  <span class="nt">&quot;username&quot;</span><span class="p">:</span> <span class="s2">&quot;jlpicard&quot;</span><span class="p">,</span>
  <span class="nt">&quot;email&quot;</span><span class="p">:</span> <span class="s2">&quot;capt@enterprise.com&quot;</span><span class="p">,</span>
  <span class="nt">&quot;givenName&quot;</span><span class="p">:</span> <span class="s2">&quot;Jean-Luc&quot;</span><span class="p">,</span>
  <span class="nt">&quot;middleName&quot;</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
  <span class="nt">&quot;surname&quot;</span><span class="p">:</span> <span class="s2">&quot;Picard&quot;</span><span class="p">,</span>
  <span class="nt">&quot;fullName&quot;</span><span class="p">:</span> <span class="s2">&quot;Jean-Luc Picard&quot;</span><span class="p">,</span>
  <span class="nt">&quot;thisExample&quot;</span><span class="p">:</span> <span class="s2">&quot;isTruncated&quot;</span><span class="p">,</span>
  <span class="nt">&quot;...&quot;</span><span class="p">:</span> <span class="s2">&quot;...&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>And one in the Facebook Directory for user Locutus:</p>
<div class="highlight-json"><div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="nt">&quot;href&quot;</span><span class="p">:</span> <span class="s2">&quot;https://api.stormpath.com/v1/accounts/raxBrEj2lkxJeQExample&quot;</span><span class="p">,</span>
  <span class="nt">&quot;username&quot;</span><span class="p">:</span> <span class="s2">&quot;locutus&quot;</span><span class="p">,</span>
  <span class="nt">&quot;email&quot;</span><span class="p">:</span> <span class="s2">&quot;locutus@b.org&quot;</span><span class="p">,</span>
  <span class="nt">&quot;givenName&quot;</span><span class="p">:</span> <span class="s2">&quot;Locutus&quot;</span><span class="p">,</span>
  <span class="nt">&quot;middleName&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
  <span class="nt">&quot;surname&quot;</span><span class="p">:</span> <span class="s2">&quot;Ofborg&quot;</span><span class="p">,</span>
  <span class="nt">&quot;fullName&quot;</span><span class="p">:</span> <span class="s2">&quot;Locutus Ofborg&quot;</span><span class="p">,</span>
  <span class="nt">&quot;thisExample&quot;</span><span class="p">:</span> <span class="s2">&quot;isTruncated&quot;</span><span class="p">,</span>
  <span class="nt">&quot;...&quot;</span><span class="p">:</span> <span class="s2">&quot;...&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>You can link these two Accounts with a simple POST:</p>
<div class="highlight-http"><div class="highlight"><pre><span></span><span class="nf">POST</span> <span class="nn">/v1/accountLinks</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">api.stormpath.com</span>
<span class="na">Authorization</span><span class="o">:</span> <span class="l">Basic MlpG...</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json</span>

<span class="p">{</span>
  <span class="nt">&quot;leftAccount&quot;</span><span class="p">:{</span>
    <span class="nt">&quot;href&quot;</span><span class="p">:</span><span class="s2">&quot;https://api.stormpath.com/v1/accounts/7hOYWCzhhKDFHFzExample&quot;</span>
  <span class="p">},</span>
  <span class="nt">&quot;rightAccount&quot;</span><span class="p">:{</span>
    <span class="nt">&quot;href&quot;</span><span class="p">:</span><span class="s2">&quot;https://api.stormpath.com/v1/accounts/raxBrEj2lkxJeQExample&quot;</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Which on success will return an Account Link:</p>
<div class="highlight-json"><div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="nt">&quot;href&quot;</span><span class="p">:</span> <span class="s2">&quot;https://api.stormpath.com/v1/accountLinks/4BK2fG2nW4G0cb42cnj8HH&quot;</span><span class="p">,</span>
  <span class="nt">&quot;createdAt&quot;</span><span class="p">:</span> <span class="s2">&quot;2016-09-28T17:32:32.327Z&quot;</span><span class="p">,</span>
  <span class="nt">&quot;modifiedAt&quot;</span><span class="p">:</span> <span class="s2">&quot;2016-09-28T17:32:32.327Z&quot;</span><span class="p">,</span>
  <span class="nt">&quot;leftAccount&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&quot;href&quot;</span><span class="p">:</span> <span class="s2">&quot;https://api.stormpath.com/v1/accounts/7hOYWCzhhKDFHFzExample&quot;</span>
  <span class="p">},</span>
  <span class="nt">&quot;rightAccount&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&quot;href&quot;</span><span class="p">:</span> <span class="s2">&quot;https://api.stormpath.com/v1/accounts/raxBrEj2lkxJeQExample&quot;</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>This means that:</p>
<ul class="simple">
<li>this Account Link will appear in both of these Accounts&#8217; <code class="docutils literal"><span class="pre">accountLinks</span></code> collections, and</li>
<li>each Account will appear in the others <code class="docutils literal"><span class="pre">linkedAccounts</span></code> collection.</li>
</ul>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Account Links can be created and deleted, but they cannot be updated. For information about Account Links, please see the <a class="reference internal" href="reference.html#ref-accountlink"><span class="std std-ref">Reference chapter</span></a></p>
</div>
<p>There is one more aspect to Account Linking, which regards login behavior (as already summarized <a class="reference internal" href="#account-linking-login"><span class="std std-ref">above</span></a>). The Application has an <a class="reference internal" href="reference.html#ref-account-linking-policy"><span class="std std-ref">Account Linking Policy</span></a>, which is enabled:</p>
<div class="highlight-json"><div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="nt">&quot;href&quot;</span><span class="p">:</span> <span class="s2">&quot;https://api.stormpath.com/v1/accountLinkingPolicies/3xX7u47eCrJTN7l6nLTMTa&quot;</span><span class="p">,</span>
  <span class="nt">&quot;createdAt&quot;</span><span class="p">:</span> <span class="s2">&quot;2016-07-21T01:03:49.813Z&quot;</span><span class="p">,</span>
  <span class="nt">&quot;modifiedAt&quot;</span><span class="p">:</span> <span class="s2">&quot;2016-09-28T18:19:09.572Z&quot;</span><span class="p">,</span>
  <span class="nt">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;ENABLED&quot;</span><span class="p">,</span>
  <span class="nt">&quot;automaticProvisioning&quot;</span><span class="p">:</span> <span class="s2">&quot;DISABLED&quot;</span><span class="p">,</span>
  <span class="nt">&quot;matchingProperty&quot;</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
  <span class="nt">&quot;tenant&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&quot;href&quot;</span><span class="p">:</span> <span class="s2">&quot;https://api.stormpath.com/v1/tenants/Ftlhx6oq2PwScGW3RsXeF&quot;</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Account Linking Policies can be associated with either an Application or Organization. If you would like to use an Organization&#8217;s Account Linking Policy then you must specify it in your login attempt.</p>
</div>
<p>Because the Account Linking Policy is enabled, and because the Cloud Directory is the default Account Store, if you send a Login Attempt with either of these Accounts, then the Account that you get back will the default Account Store&#8217;s Picard Account. In other words: If you log in with the Picard Account credentials, Stormpath will return the Picard Account, and if you log in with the Locutus Account credentials, Stormpath will still return the Picard Account.</p>
<p>This is because Stormpath traverses the Account Links for the Account that is logging-in to see if a linked Account exists in the Application&#8217;s default Account Store. Because Picard is in the default Account Store, Stormpath still just returns the Picard Account. However, the Locutus Account is not in the default Account Store, but is linked to the Picard Account which is in the default Account Store, so the Picard Account is returned.</p>
<p>This behavior exists only because the Account Linking Policy is set as <code class="docutils literal"><span class="pre">enabled</span></code>. If it were <code class="docutils literal"><span class="pre">disabled</span></code> then Stormpath would not follow Account Links. This means that you would still be able to link the two Accounts, but upon login you would receive back whichever Account was used to log-in.</p>
</div>
<div class="section" id="how-to-link-accounts-automatically">
<span id="account-linking-automatic"></span><h3>How to Link Accounts Automatically<a class="headerlink" href="#how-to-link-accounts-automatically" title="Permalink to this headline">¶</a></h3>
<p>So far we have covered how to link Accounts manually. However, it is also possible to link Accounts automatically at login time. This linking behavior is controlled by an Account Linking Policy.</p>
<div class="section" id="what-s-in-the-account-linking-policy">
<span id="about-alp"></span><h4>What&#8217;s in the Account Linking Policy<a class="headerlink" href="#what-s-in-the-account-linking-policy" title="Permalink to this headline">¶</a></h4>
<p>Every Application and Organization has an Account Linking Policy resource. In both cases the path is the same:</p>
<p><code class="docutils literal"><span class="pre">/v1/accountLinkingPolicies/$ACCOUNT_LINKING_POLICY_ID</span></code></p>
<p>The Account Linking Policy has three attributes that control aspects of Account Linking behavior:</p>
<p><strong>Status:</strong></p>
<p>This attribute controls whether this Policy is in effect or not. If you would not like this policy to be in effect, set this to <code class="docutils literal"><span class="pre">DISABLED</span></code>.</p>
<p>If Account Linking is enabled then Stormpath will check linked Accounts on login and behave as described in <a class="reference internal" href="#account-linking-login"><span class="std std-ref">How Login Works with Linked Accounts</span></a>. If it is disabled, you are still able to link Accounts manually, but Stormpath takes no actions based upon these links.</p>
<p><strong>Automatic Provisioning:</strong></p>
<p>This attribute tells Stormpath whether you would like new Accounts to be automatically created in the default Account Store.</p>
<p>For example: if a user Account is created in a Social Directory (e.g. Google), and they do not already have an Account in the default Account Store, Automatic Provisioning would then create an Account with the same information inside the default Account Store. That Account would then be automatically linked to the Account in the Social Directory.</p>
<p><strong>Matching Property</strong></p>
<p>This defines what Account attribute should be used as a basis for automatically creating account links. The current possible values are:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">null</span></code>: which means that you would not like any matching to occur</li>
<li><code class="docutils literal"><span class="pre">email</span></code>: which will match Accounts based on their <code class="docutils literal"><span class="pre">email</span></code> attribute.</li>
</ul>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The <code class="docutils literal"><span class="pre">email</span></code> matchingProperty will only match verified Accounts. For more on this, see <a class="reference internal" href="#account-linking-verification"><span class="std std-ref">Account Matching and Account Verification</span></a>.</p>
</div>
<p><strong>Policy Values and Outcomes</strong></p>
<p>Because logging in via a Mirror Directory (Social, SAML, etc) will create an Account if it doesn&#8217;t already exist, Automatic Provisioning and the Matching Property are intended for use with Mirror Directory login. So what happens if a user logs in via a Mirror Directory? First of all, if the external credentials are valid, Stormpath creates an Account for them in that Mirror Directory. What happens next depends on the configuration of your Account Linking Policy.</p>
<p>Default behavior, without Account Linking, is that the newly-created Account from the Mirror Directory will be returned.</p>
<p>This table shows the possible combinations of Account Linking Policy values. It also indicates whether a matching Account exists in the default Account Store (which must be a Cloud Account), and then the result to expect when logging in with a new Mirror Directory.</p>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="10%" />
<col width="15%" />
<col width="30%" />
<col width="35%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Automatic Provisioning</th>
<th class="head">Matching Property</th>
<th class="head">Matching Account Exists?</th>
<th class="head">Result</th>
<th class="head">Explanation</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>Disabled</td>
<td>Null</td>
<td>No</td>
<td>Return Account that was logged in.</td>
<td>No action taken by Stormpath.</td>
</tr>
<tr class="row-odd"><td>Disabled</td>
<td>Null</td>
<td>Yes</td>
<td>Return Account that was logged in.</td>
<td>No action taken by Stormpath.</td>
</tr>
<tr class="row-even"><td>Disabled</td>
<td>Email</td>
<td>No</td>
<td>Return Account that was logged in.</td>
<td>No action taken by Stormpath.</td>
</tr>
<tr class="row-odd"><td>Disabled</td>
<td>Email</td>
<td>Yes</td>
<td>Cloud Account is returned.</td>
<td>Stormpath links new Account to existing Account and returns existing Account.</td>
</tr>
<tr class="row-even"><td>Enabled</td>
<td>Null</td>
<td>No</td>
<td>Cloud Account is returned.</td>
<td>Account created in Cloud Directory and both Accounts are linked.</td>
</tr>
<tr class="row-odd"><td>Enabled</td>
<td>Null</td>
<td>Yes</td>
<td>Return Account that was logged in.</td>
<td>Stormpath attempts to create Account in Cloud Directory but cannot because of email uniqueness constraint.</td>
</tr>
<tr class="row-even"><td>Enabled</td>
<td>Email</td>
<td>No</td>
<td>Cloud Account is returned.</td>
<td>New Account created, then Cloud Account created, then both Accounts linked.</td>
</tr>
<tr class="row-odd"><td>Enabled</td>
<td>Email</td>
<td>Yes</td>
<td>Cloud Account is returned.</td>
<td>New Account created, then linked to existing Cloud Account.</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The above table assumes that you are either sending a <a class="reference internal" href="auth_n.html#how-login-works"><span class="std std-ref">Login Attempt</span></a> or a Social Login POST to the <a class="reference internal" href="auth_n.html#social-authn"><span class="std std-ref">Application&#8217;s Accounts endpoint</span></a>. In the case of the <a class="reference internal" href="auth_n.html#generate-oauth-token"><span class="std std-ref">OAuth flow</span></a>, instead of getting back an Account, you would receive back OAuth Tokens associated with that Account.</p>
</div>
</div>
<div class="section" id="account-matching-and-account-verification">
<span id="account-linking-verification"></span><h4>Account Matching and Account Verification<a class="headerlink" href="#account-matching-and-account-verification" title="Permalink to this headline">¶</a></h4>
<p>Stormpath will only automatically link to and from Accounts that have had their email verified.</p>
<p>Accounts in Mirror Directories will have their email verification status verified on creation, as will any Accounts that are automatically provisioned from Accounts that are themselves verified.</p>
</div>
<div class="section" id="example-scenario-1">
<span id="account-linking-automatic-ex1"></span><h4>Example Scenario 1<a class="headerlink" href="#example-scenario-1" title="Permalink to this headline">¶</a></h4>
<p>This is probably the most common scenario, where you want to allow your users Social Login, but also want to maintain a separate canonical user Directory. In this example you have:</p>
<ul class="simple">
<li>A Cloud Directory (the default Account Store)</li>
<li>A Google Directory</li>
<li>A Facebook Directory</li>
</ul>
<p>Your Application&#8217;s Account Linking Policy has:</p>
<div class="highlight-json"><div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="nt">&quot;href&quot;</span><span class="p">:</span> <span class="s2">&quot;https://api.stormpath.com/v1/accountLinkingPolicies/3xX7u47eCrJTN7l6nLTMTa&quot;</span><span class="p">,</span>
  <span class="nt">&quot;createdAt&quot;</span><span class="p">:</span> <span class="s2">&quot;2016-07-21T01:03:49.813Z&quot;</span><span class="p">,</span>
  <span class="nt">&quot;modifiedAt&quot;</span><span class="p">:</span> <span class="s2">&quot;2016-09-28T18:19:09.572Z&quot;</span><span class="p">,</span>
  <span class="nt">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;ENABLED&quot;</span><span class="p">,</span>
  <span class="nt">&quot;automaticProvisioning&quot;</span><span class="p">:</span> <span class="s2">&quot;ENABLED&quot;</span><span class="p">,</span>
  <span class="nt">&quot;matchingProperty&quot;</span><span class="p">:</span> <span class="s2">&quot;email&quot;</span><span class="p">,</span>
  <span class="nt">&quot;tenant&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&quot;href&quot;</span><span class="p">:</span> <span class="s2">&quot;https://api.stormpath.com/v1/tenants/Ftlhx6oq2PwScGW3RsXeF&quot;</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>So when Janelle, a new user of your application, clicks on the &#8220;Login with Facebook&#8221; button on your login page, you have it send a login attempt:</p>
<div class="highlight-http"><div class="highlight"><pre><span></span><span class="nf">POST</span> <span class="nn">/v1/applications/560ySU9jUOCFMXsIM1fcGC/accounts</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">api.stormpath.com</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Authorization</span><span class="o">:</span> <span class="l">Basic NjUxW...</span>
<span class="na">Cache-Control</span><span class="o">:</span> <span class="l">no-cache</span>

<span class="p">{</span>
  <span class="nt">&quot;providerData&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&quot;providerId&quot;</span><span class="p">:</span> <span class="s2">&quot;facebook&quot;</span><span class="p">,</span>
    <span class="nt">&quot;accessToken&quot;</span><span class="p">:</span> <span class="s2">&quot;EAAT68k[...]T8TAZDZD&quot;</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>After the credentials are validated, Stormpath will do a few things:</p>
<ol class="arabic simple">
<li>Create an Account in the Facebook Directory.</li>
<li>Because the Matching Property is &#8220;email&#8221; Stormpath will next check if there are any Accounts to link this Account with. This user has never used your app before, so there are no other Accounts using this email.</li>
<li>Create an Account in the Cloud Directory with the same information as the one in the Facebook Directory.</li>
<li>Link the Accounts in the Facebook and Cloud Directories to each other.</li>
</ol>
<p>Your user Janelle now has an Account in the Facebook Directory, an Account in the Cloud Directory, and both of these Accounts are linked via accountLink resources.</p>
<p>Stormpath will now return the Account from the Cloud Directory:</p>
<div class="highlight-json"><div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="nt">&quot;href&quot;</span><span class="p">:</span> <span class="s2">&quot;https://api.stormpath.com/v1/accounts/4Ne98Nh3OscHLuBexample&quot;</span><span class="p">,</span>
  <span class="nt">&quot;username&quot;</span><span class="p">:</span> <span class="s2">&quot;jkallday@email.com&quot;</span><span class="p">,</span>
  <span class="nt">&quot;email&quot;</span><span class="p">:</span> <span class="s2">&quot;jkallday@email.com&quot;</span><span class="p">,</span>
  <span class="nt">&quot;givenName&quot;</span><span class="p">:</span> <span class="s2">&quot;Janelle&quot;</span><span class="p">,</span>
  <span class="nt">&quot;...&quot;</span><span class="p">:</span><span class="s2">&quot;...&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>If at a later date she were to choose to login via Google, then (assuming her Facebook and Google use the same email) Stormpath would create an Account for her in the Google Directory, link it to the Cloud Directory Account, and then return that Cloud Account.</p>
</div>
<div class="section" id="example-scenario-2">
<span id="account-linking-automatic-ex2"></span><h4>Example Scenario 2<a class="headerlink" href="#example-scenario-2" title="Permalink to this headline">¶</a></h4>
<p>In this example we will show a <a class="reference internal" href="multitenancy.html#multitenancy"><span class="std std-ref">multi-tenant application</span></a> that wants to let each of its tenants decide on their own Account Linking behavior. In order to accomplish this, there a few things that need to happen:</p>
<ul class="simple">
<li>the Application&#8217;s Account Linking Policy is irrelevant, since it will be skipped if we specify an Organization in the login attempt</li>
<li>the Organization Account Linking Policies are used to control Account Linking behavior</li>
<li>Every Organization has its own Cloud Directory that serves as its default Account Store. Mirror Directories can be shared between Organizations.</li>
<li>The login page for this application must pass the user&#8217;s Organization <code class="docutils literal"><span class="pre">href</span></code> or <code class="docutils literal"><span class="pre">nameKey</span></code> with every login attempt.</li>
</ul>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Whether the Application&#8217;s Account Linking Policy</p>
</div>
<p>So a login attempt to a Facebook Directory would look like the one above, but with an Account Store specified as well, in this case an Organization <code class="docutils literal"><span class="pre">nameKey</span></code>:</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>.. code-block:: http

POST /v1/applications/1FxaAPbyW3JqNLbsPaH26R/accounts HTTP/1.1
Host: api.stormpath.com
Content-Type: application/json
Authorization: Basic NjUxW...
Cache-Control: no-cache

{
  &quot;providerData&quot;: {
    &quot;providerId&quot;: &quot;facebook&quot;,
    &quot;accessToken&quot;: &quot;EAAT68k[...]T8TAZDZD&quot;
    &quot;accountStore&quot;: {
      &quot;nameKey&quot;: &quot;OrganizationA&quot;
    }
  }
}
</pre></div>
</div>
<p>This targeted login attempt would tell Stormpath to go to that specific Organization&#8217;s Directories to find the Account. From that point on, any Account creation and linking policies would be enacted based on the policies associated with that particular Organization&#8217;s Directories.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The behavior described above would be the same if we made a POST to the <code class="docutils literal"><span class="pre">/loginAttempts</span></code> endpoint, or used the OAuth flow.</p>
</div>
</div>
</div>
</div>
</div>


           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="auth_n.html" class="btn btn-neutral float-right" title="4. Authenticating Accounts with Stormpath" accesskey="n">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="quickstart.html" class="btn btn-neutral" title="2. Quickstart" accesskey="p"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2016, Stormpath, Inc.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'./',
            VERSION:'',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="_static/jquery.js"></script>
      <script type="text/javascript" src="_static/underscore.js"></script>
      <script type="text/javascript" src="_static/doctools.js"></script>
      <script type="text/javascript" src="_static/javascript_for_java.js"></script>
      <script type="text/javascript" src="_static/langpicker.js"></script>
      <script type="text/javascript" src="_static/scrollspy.js"></script>
      <script type="text/javascript" src="_static/gumshoe.min.js"></script>

  

  
  
    <script type="text/javascript" src="_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>